# 한결 (Hangyeol) 분석 로직 상세 분석 (Deep Dive)

이 문서는 `한결` 프로젝트의 핵심인 한국어 텍스트 분석 과정에 대한 기술적 상세 보고서입니다. 사용자의 입력 문장이 어떤 과정을 거쳐 형태소로 분리되고, 데이터베이스와 매핑되어 최종 등급이 산정되는지 그 논리적 흐름을 면밀히 분석했습니다.

---

## 1. 분석 프로세스 개요 (Analysis Pipeline)

전체 분석 과정은 크게 **4단계**로 나뉩니다.

1.  **전처리 및 토큰화 (Tokenization)**: Kiwi 형태소 분석기를 사용해 문장을 최소 단위(토큰)로 쪼갭니다.
2.  **데이터베이스 매핑 (Classification)**: 각 토큰을 내부 등급 데이터베이스(`word.csv`, `grammar.csv`)와 대조합니다.
3.  **고급 병합 및 교정 (Refinement)**: 관용구, 복합어 파생어, 동사 활용형 등을 감지하여 병합합니다.
4.  **최종 산정 (Finalization)**: AI를 통한 동음이의어 판별 후 최종 등급 수치를 계산합니다.

---

## 2. 단계별 상세 로직

### Step 1. 형태소 분석 (Morphological Analysis)
- **담당 모듈**: `MorphService` (`morph_service.py`), `Kiwi` 라이브러리
- **동작**:
    - 입력된 문장을 Kiwi 분석기에 전달하여 형태소 단위로 분리합니다.
    - 각 토큰 정보 획득: `form`(형태), `tag`(품사 코드), `start`(시작 위치), `len`(길이).
    - **예시**: "공부를 했다" -> `[('공부', 'NNG'), ('를', 'JKO'), ('하', 'VV'), ('었', 'EP'), ('다', 'EF')]`

### Step 2. 데이터베이스 로딩 및 매핑 구조
- **담당 모듈**: `GradeDatabase` (`grade_database.py`)
- **구조**:
    - **`word_map` (단어 지도)**: `word.csv` 기반. `(정제된단어, 범주)`를 키(Key)로 가짐.
        - 범주 매핑: `NNG`->`N`(명사), `VV`->`V`(동사) 등으로 단순화하여 매핑.
    - **`grammar_map` (문법 지도)**: `grammar.csv` 기반. 조사, 어미뿐만 아니라 '문법적 표현'(`어지다` 등)도 포함.
    - **`grammar_map` (문법 지도)**: `grammar.csv` 기반. 조사, 어미뿐만 아니라 '문법적 표현'(`어지다` 등)도 포함.
    - **`expression_map` (표현 지도)**: `grammar.csv` 기반. (구 `idiom_map`)
        - **생성 원리**: 문법 데이터 중 '대표형'에 **띄어쓰기**가 포함되어 있거나, 분류가 **'표현'**으로 지정된 항목을 추출합니다.
        - **구조**: `(시작 단어) -> [나머지 단어 시퀀스]` 형태로 변환하여, 문장에서 연쇄적으로 단어가 등장할 때 이를 하나의 관용적 표현으로 인식하도록 합니다.
        - **예시**: `-ㄹ 수 있다`, `-기로 하다` 등.

### Step 3. 프로파일링 및 병합 논리 (Core Logic)
- **담당 모듈**: `GradeProfiler` (`grade_profiler.py`)
- **반복 구조**: 토큰 리스트를 처음부터 순회(`while loop`)하며 아래 **우선순위**에 따라 처리합니다.

#### 3-1. 문법 표현(Expression) 패턴 매칭 [최우선]
- **논리**: 현재 토큰이 `expression_map`의 시작 단어와 일치하는지 확인합니다.
- **동작**: 뒤따르는 토큰들이 표현의 구성 요소와 정확히 일치하면, 해당 토큰들을 모두 하나로 묶습니다.
- **예시**: `기` + `로` + `하` + `다` 발견 -> **"-기로 하다"** (문법적 표현)으로 병합 및 등급 판정.

#### 3-2. 지정사 (VCP) 강제 매핑
- **논리**: `이다`(VCP)는 활용형이 다양하므로, 태그가 `VCP`로 시작하면 무조건 데이터베이스의 '이다' 항목(1급)으로 매핑합니다.

#### 3-3. 2-gram 복합어/파생어 병합 (Lookahead Merge)
가장 중요한 로직 중 하나로, Kiwi가 쪼개놓은 형태소를 다시 합쳐서 사전에 있는 단어인지 확인합니다.

1.  **대상**: 현재 토큰 + 다음 토큰 (`i` + `i+1`)
2.  **검색 전략**: 합친 형태(`combined_form`)가 DB에 있는지 확인합니다.
    - **우선순위**: 명사(N) -> 의존명사(NB) -> 동사(V) -> 부사 등 순으로 스캔.
    - **확장 검색 (Expansion)**: 동사(V)나 기타(ETC) 범주 검색 시, 합친 형태에 **'-다'를 붙여서** 한 번 더 검색합니다.
        - *원인*: `어지다`의 경우 Kiwi는 `어`+`지`로 쪼개지만, DB에는 `어지다`로 저장되어 있음.
        - *해결*: `어`+`지` -> `어지` -> `어지다`로 변형하여 검색 성공.
3.  **교차 검색 (Dual Lookup)**:
    - `word_map` (단어 DB) 뿐만 아니라 **`grammar_map` (문법 DB)** 안에서도 병합 대상을 찾습니다.
    - 이를 통해 '어지다'(문법 표현)와 '선생님'(파생 명사) 모두를 정확히 찾아냅니다.
4.  **결과 처리**:
    - 병합 성공 시 두 토큰을 하나로 합치고 루프를 건너뜁니다.
    - **품사명 동적 할당**:
        - 병합된 단어의 경우: 구성 요소에 따라 "복합어" 또는 "동사/형용사(파생)" 등으로 태그를 부여합니다.
        - 단일 단어의 경우: **Kiwi가 분석한 실제 품사 태그**(`NNG`, `VV` 등)를 바탕으로 "일반 명사", "동사" 등 구체적인 품사명을 부여합니다.

#### 3-4. 단일 토큰 처리 (Fallback)
병합되지 않은 나머지 토큰들은 개별적으로 처리합니다.
- **품사 매핑 (내부 검색용)**: `GradeDatabase.pos_map`을 이용해 일반화된 키(Key)로 변환하여 DB를 조회합니다. (예: `NNG`, `NNP` -> `N`).
    - *참고*: 이는 DB 검색을 위한 과정이며, 최종 결과(`tag_code`, `tag_name`)에는 Kiwi가 분석한 **원본 상세 품사**(`NNG` 등)가 그대로 기록됩니다.
- **자동 보정**: 동사(`V`)인 경우 끝이 '다'로 끝나지 않으면 자동으로 '-다'를 붙여서 원형을 검색합니다. (예: `먹` -> `먹다`).
- **검색**: `word_map`과 `grammar_map`을 모두 뒤져서 등급 정보를 가져옵니다.

---

## 4. 모호성 해결 심화 (Disambiguation)

### 동음이의어 (Homonyms)
하나의 단어 형태에 여러 ID(의미)가 매핑된 경우입니다. 이때 후보군(`candidates`)들은 **표제어(Form)와 품사 범주(POS)**가 동일하지만, 의미와 등급이 다른 항목들입니다. (예: '말'(N) -> 언어(1급) vs 동물(1급)).

1.  **후보군 수집**: DB 조회 결과 리스트(`candidates`)가 2개 이상이면 `ambiguous_items` 리스트에 저장합니다.
2.  **AI 분석 (`_disambiguate_with_ai`)**:
    - 모든 1차 분석이 끝난 후, 수집된 모호한 단어들의 목록과 **전체 문장(문맥)**을 AI에게 보냅니다.
    - **Prompt**: "이 문맥에서 '말'은 어떤 의미인가?" (후보 ID 목록 제공)
    - **결과 적용**: AI가 선택한 ID로 해당 단어의 최종 등급과 의미를 확정 짓습니다.

---

## 5. 최종 데이터 구조 (Output)

분석 테이블에 표시되는 최종 데이터 구조는 다음과 같습니다.

| 필드 | 설명 | 비고 |
| :--- | :--- | :--- |
| **form** | 화면에 표시될 텍스트 | 예: `선생님`, `어지다` (병합된 형태) |
| **tag_code** | 원본 품사 코드 | 예: `NNG+XSN` |
| **tag_name** | 사용자 친화적 품사명 | **DB 기반 동적 결정** (예: 문법적 표현, 일반 명사) |
| **level** | 배정된 등급 | 예: `1급`, `등급 없음` |
| **id** | 데이터베이스 ID | 예: `단어#1234` |
| **desc** | 길잡이말 (힌트) | 예: `학교 선생님` |

이 모든 정보는 `AnalysisService`에서 최종 집계되어(통계 산출) 프론트엔드로 전달됩니다.
