<!-- [NEW] ì‹œê°í™” ì„¹ì…˜ (ì›ê·¸ë˜í”„ + í•˜ì´ë¼ì´íŠ¸ ì›ë¬¸ + íŒŒì¼ë³„ ë¹„êµ) -->
<hr style="margin: 3rem 0; border-color: var(--muted-border-color);">

<div class="visualization-container" style="display: flex; flex-direction: column; gap: 2rem;">

    <!-- 1. íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="openVizTab(event, 'tab-overall')">ì›ê·¸ë˜í”„</button>
        <button class="nav-tab" onclick="openVizTab(event, 'tab-comparison')">ë¹„ìœ¨ë§‰ëŒ€ê·¸ë¦¼</button>
        <button class="nav-tab" onclick="openVizTab(event, 'tab-absolute')">ë¹ˆë„ë§‰ëŒ€ê·¸ë¦¼</button>
    </div>

    <!-- 2. íƒ­ ì½˜í…ì¸  ì˜ì—­ -->
    <div class="tab-content-container">

        <!-- Tab 1: ì¢…í•© ë¶„í¬ (ê¸°ì¡´ ì›ê·¸ë˜í”„) -->
        <div id="tab-overall" class="viz-tab-pane active" style="display: block;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0; font-weight: 700;">ğŸ° ë“±ê¸‰ ë¶„í¬ ì›ê·¸ë˜í”„</h3>

                <!-- [NEW] í†µí•©/ê°œë³„ í† ê¸€ ìŠ¤ìœ„ì¹˜ -->
                <div class="toggle-container" style="font-size: 0.9rem; display: flex; align-items: center; gap: 15px;">
                    <div style="margin-right: 15px;">
                        <label style="cursor: pointer; margin-right: 10px;">
                            <input type="radio" name="pie-mode" value="integrated" checked
                                onchange="togglePieMode(this.value)">
                            í†µí•©
                        </label>
                        <label style="cursor: pointer;">
                            <input type="radio" name="pie-mode" value="individual" onchange="togglePieMode(this.value)">
                            ê°œë³„
                        </label>
                    </div>
                </div>
            </div>

            <!-- í†µí•© ì°¨íŠ¸ ì˜ì—­ -->
            <div id="integrated-chart-area" style="max-width: 500px; margin: 0 auto; display: block;">
                <div id="gradeChart"></div>
            </div>

            <!-- [NEW] Shared Legend Container (Initially Hidden) -->
            <div id="shared-pie-legend"
                style="display: none; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <!-- JS will populate this -->
            </div>

            <!-- [NEW] ê°œë³„ ì°¨íŠ¸ ì˜ì—­ (Grid Layout) -->
            <div id="individual-charts-container"
                style="display: none; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                <!-- JSë¡œ ë™ì  ìƒì„±ë¨ -->
            </div>
        </div>

        <!-- Tab 2: íŒŒì¼ë³„ ë¹„êµ (ëˆ„ì  ë¹„ìœ¨) -->
        <div id="tab-comparison" class="viz-tab-pane" style="display: none;">
            <h3 style="margin-bottom: 1rem; font-weight: 700;">ğŸ“Š íŒŒì¼ë³„ í…ìŠ¤íŠ¸ ì–´íœ˜ ë“±ê¸‰ ë¶„í¬ ë¹„êµ (ë¹„ìœ¨)</h3>
            <p style="color: var(--color-text-muted); font-size: 0.9rem; margin-bottom: 1rem; text-align: center;">
                * ê° í…ìŠ¤íŠ¸ íŒŒì¼ ë‚´ ì–´íœ˜ ë“±ê¸‰ ë¹„ìœ¨ì„ í•œëˆˆì— ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <div id="fileComparisonChart" style="width: 100%; height: 500px;"></div>

            <!-- ë“±ê¸‰ ì—†ìŒ í¬í•¨ ì²´í¬ë°•ìŠ¤ -->
            <div style="text-align: right; margin-top: 10px;">
                <label
                    style="cursor: pointer; font-size: 0.95rem; user-select: none; display: inline-flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="include-ungraded-toggle" onchange="toggleUngradedSeries(this)">
                    <span>'ë“±ê¸‰ ì—†ìŒ' í¬í•¨í•˜ì—¬ ë³´ê¸°</span>
                </label>
            </div>
        </div>

        <!-- Tab 3: íŒŒì¼ë³„ ë¹„êµ (ì ˆëŒ€ ë¹ˆë„) -->
        <div id="tab-absolute" class="viz-tab-pane" style="display: none;">
            <h3 style="margin-bottom: 1rem; font-weight: 700;">ğŸ“ˆ íŒŒì¼ë³„ ì–´íœ˜ ë¹ˆë„ìˆ˜ ë¹„êµ (ì ˆëŒ€ë¹ˆë„)</h3>
            <p style="color: var(--color-text-muted); font-size: 0.9rem; margin-bottom: 1rem; text-align: center;">
                * ê° í…ìŠ¤íŠ¸ íŒŒì¼ì˜ ì „ì²´ ë‹¨ì–´ ìˆ˜ì™€ ë“±ê¸‰ë³„ ë‹¨ì–´ ìˆ˜ë¥¼ ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <div id="fileAbsoluteChart" style="width: 100%; height: 500px;"></div>
        </div>

    </div>

    <!-- 3. í•˜ì´ë¼ì´íŠ¸ ì›ë¬¸ ì˜ì—­ (ê³µí†µ) -->
    <div style="margin-top: 1rem;">
        <h3 style="margin-bottom: 1rem; font-weight: 700;">ğŸ“ ì‹œê°í™”ëœ ì›ë¬¸</h3>
        <p style="color: var(--color-text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
            * ê·¸ë˜í”„ì˜ ê° ì¡°ê°ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ í•´ë‹¹ ë“±ê¸‰ì˜ ë‹¨ì–´ê°€ ê°•ì¡°ë©ë‹ˆë‹¤.
        </p>
        <!-- [NEW] íŒŒì¼ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
        {% if file_text_contents and file_text_contents|length > 1 %}
        <div style="margin-bottom: 1rem; text-align: right;">
            <select id="text-file-select" onchange="filterTextFile(this.value)"
                style="padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--muted-border-color); background-color: var(--color-card-bg); color: var(--color-text); font-size: 1rem;">
                {% for file_item in file_text_contents %}
                <option value="file-content-{{ loop.index }}">{{ file_item.filename }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <div id="highlighted-text-box"
            style="padding: 1.5rem; border-radius: 12px; line-height: 2.0; font-size: 1.2rem; border: 1px solid var(--muted-border-color); max-height: 500px; overflow-y: auto;">

            {% if file_text_contents %}
            {% for file_item in file_text_contents %}
            <div id="file-content-{{ loop.index }}" class="file-text-content"
                style="display: {{ 'block' if loop.first else 'none' }}">
                {% for seg in file_item.segments %}
                {% if seg.type == 'graded' %}
                <span class="interactive-word {{ seg.class }}" data-grade="{{ seg.class }}"
                    data-offset="{{ seg.info.offset_start }}" data-ui-id="{{ seg.info._ui_id }}"
                    data-tooltip="{{ seg.info.level }} - {{ seg.info.desc }}">
                    {{ seg.text }}
                </span>
                {% else %}
                <span>{{ seg.text }}</span>
                {% endif %}
                {% endfor %}
            </div>
            {% endfor %}
            {% else %}
            <p style="color: var(--color-text-muted);">ì‹œê°í™”í•  í…ìŠ¤íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
        </div>
    </div>

</div>

<!-- Data Passing (Safe Pattern) -->
<script id="viz-data-labels" type="application/json">
    {{ visualization_data.labels | tojson | default('[]') }}
</script>
<script id="viz-data-data" type="application/json">
    {{ visualization_data.data | tojson | default('[]') }}
</script>
<script id="viz-file-stats" type="application/json">
    {{ file_stats_list | tojson | default('[]') }}
</script>

<!-- Highcharts ë¡œë“œ í™•ì¸ ë° ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ -->
<script>
    console.log("[visualization.html] Script loaded (Safe Pattern).");

    // Highcharts ë¡œë“œ ì—¬ë¶€ ì²´í‚¹ í•¨ìˆ˜
    function loadHighcharts(callback) {
        if (window.Highcharts && window.Highcharts.chart) {
            callback();
            return;
        }
        // Highchartsê°€ ì—†ìœ¼ë©´ ë™ì  ë¡œë“œ (CDN)
        const scriptMain = document.createElement('script');
        scriptMain.src = 'https://code.highcharts.com/highcharts.js';
        scriptMain.onload = function () {
            const script3d = document.createElement('script');
            script3d.src = 'https://code.highcharts.com/highcharts-3d.js';
            script3d.onload = callback; // 3D ëª¨ë“ˆ ë¡œë“œ í›„ ì½œë°± ì‹¤í–‰
            document.head.appendChild(script3d);
        };
        document.head.appendChild(scriptMain);
    }

    let gradeChartInstance = null; // Donut Chart instance
    let comparisonChartInstance = null; // Ratio Bar Chart instance
    let absoluteChartInstance = null; // Absolute Bar Chart instance

    // [New] Global Data Variables
    let globalInitialLabels = [];
    let globalInitialData = [];
    let globalFileStats = [];

    // íƒ­ ì „í™˜ í•¨ìˆ˜
    window.openVizTab = function (evt, tabId) {
        // 1. ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¹€
        const tabContents = document.getElementsByClassName("viz-tab-pane");
        for (let i = 0; i < tabContents.length; i++) {
            tabContents[i].style.display = "none";
        }

        // 2. ëª¨ë“  íƒ­ ë²„íŠ¼ active í´ë˜ìŠ¤ ì œê±°
        const tabLinks = document.getElementsByClassName("nav-tab");
        for (let i = 0; i < tabLinks.length; i++) {
            tabLinks[i].className = tabLinks[i].className.replace(" active", "");
        }

        // 3. ì„ íƒëœ íƒ­ ë³´ì´ê¸° ë° active í´ë˜ìŠ¤ ì¶”ê°€
        document.getElementById(tabId).style.display = "block";
        evt.currentTarget.className += " active";

        // 4. ì°¨íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ (ìˆ¨ê²¨ì ¸ ìˆë˜ ì°¨íŠ¸ëŠ” ì‚¬ì´ì¦ˆê°€ ê¹¨ì§ˆ ìˆ˜ ìˆìŒ)
        if (tabId === 'tab-comparison' && comparisonChartInstance) {
            comparisonChartInstance.reflow();
        } else if (tabId === 'tab-overall' && gradeChartInstance) {
            gradeChartInstance.reflow();
        } else if (tabId === 'tab-absolute' && absoluteChartInstance) {
            absoluteChartInstance.reflow();
        }
        // ê°œë³„ ì°¨íŠ¸ë„ ë¦¬ì‚¬ì´ì¦ˆ
        if (tabId === 'tab-overall') {
            const individualContainer = document.getElementById('individual-charts-container');
            if (individualContainer.style.display !== 'none') {
                Highcharts.charts.forEach(chart => {
                    if (chart && chart.options.chart.type === 'pie') {
                        chart.reflow();
                    }
                });
            }
        }
    };

    // Global function to refresh chart from table data (Legacy support for Donut)
    window.refreshGradeChart = function () {
        // Legacy support removed to simplify - full reload preferred for this complexity
    };

    window.updateOverallGrade = function (maxGrade) {
        const gradeText = maxGrade > 0 ? `${maxGrade}ê¸‰` : 'ë¶„ì„ë¶ˆê°€';
        const overallText = document.getElementById('overall-grade-text');
        if (overallText) overallText.innerText = gradeText;
        const overallBadge = document.getElementById('overall-grade-badge');
        if (overallBadge) {
            overallBadge.className = `grade-badge grade-${maxGrade}`;
            overallBadge.innerText = `ìµœì¢…: ${gradeText}`;
        }
    };

    // [New] Toggle Ungraded Series (Bar Chart)
    window.toggleUngradedSeries = function (checkbox) {
        if (!comparisonChartInstance) return;

        // 'ë“±ê¸‰ ì—†ìŒ' ì‹œë¦¬ì¦ˆ ì°¾ê¸°
        const ungradedSeries = comparisonChartInstance.series.find(s => s.name === 'ë“±ê¸‰ ì—†ìŒ');
        if (ungradedSeries) {
            ungradedSeries.setVisible(checkbox.checked);
        }
    };

    // [New] Render Comparison Chart (Ratio)
    function renderComparisonChart(fileStats) {
        if (!fileStats || fileStats.length === 0) return;

        // Xì¶• ì¹´í…Œê³ ë¦¬ (íŒŒì¼ëª…)
        const categories = fileStats.map(item => {
            const name = item.filename;
            return name.length > 15 ? name.substring(0, 15) + '...' : name;
        });

        // 1ê¸‰ ~ 6ê¸‰ + ë“±ê¸‰ ì—†ìŒ ì‹œë¦¬ì¦ˆ ë°ì´í„° êµ¬ì„±
        const gradeKeys = ['1ê¸‰', '2ê¸‰', '3ê¸‰', '4ê¸‰', '5ê¸‰', '6ê¸‰', 'ë“±ê¸‰ ì—†ìŒ'];
        const gradeColors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#64748b', '#94a3b8'];

        const seriesData = gradeKeys.map((key, index) => {
            return {
                name: key,
                color: gradeColors[index],
                data: fileStats.map(item => item.stats[key] || 0), // ê° íŒŒì¼ë³„ í•´ë‹¹ ê¸‰ìˆ˜ ë¹ˆë„
                visible: key !== 'ë“±ê¸‰ ì—†ìŒ' // 'ë“±ê¸‰ ì—†ìŒ'ì€ ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ (ì²´í¬ë°•ìŠ¤ë¡œ ì œì–´)
            };
        });

        comparisonChartInstance = Highcharts.chart('fileComparisonChart', {
            chart: {
                type: 'bar', // ê°€ë¡œ ë§‰ëŒ€ ê·¸ë˜í”„
                backgroundColor: 'transparent',
                style: { fontFamily: 'var(--font-family)' }
            },
            title: { text: '' },
            xAxis: {
                categories: categories,
                title: { text: null },
                labels: {
                    style: {
                        color: 'var(--color-text)', // ë‹¤í¬ëª¨ë“œ ëŒ€ì‘
                        fontSize: '14px',
                        fontWeight: '500'
                    }
                },
                lineWidth: 0,
                tickWidth: 0
            },
            yAxis: {
                min: 0,
                max: 100, // 100% ê½‰ ì°¨ê²Œ
                title: {
                    text: 'ë¹„ìœ¨ (%)',
                    align: 'high',
                    style: { color: 'var(--color-text-muted)' }
                },
                labels: {
                    overflow: 'justify',
                    style: { color: 'var(--color-text-muted)' }
                },
                reversedStacks: false // 1ê¸‰ì´ ì™¼ìª½(ì¶• ì‹œì‘ì )ì— ì˜¤ë„ë¡ ì„¤ì •
            },
            tooltip: {
                pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.percentage:.1f}%)<br/>',
                shared: true,
                backgroundColor: 'var(--color-card-bg)',
                borderColor: 'var(--color-card-border)',
                style: { color: 'var(--color-text)' }
            },
            plotOptions: {
                bar: {
                    stacking: 'percent', // 100% ëˆ„ì  ë§‰ëŒ€
                    groupPadding: 0.02,   // ë§‰ëŒ€ ì‚¬ì´ ê°„ê²© ìµœì†Œí™”
                    pointPadding: 0.02,   // í¬ì¸íŠ¸ ê°„ ê°„ê²© ìµœì†Œí™”
                    borderWidth: 0,
                    dataLabels: {
                        enabled: true,
                        format: '{point.percentage:.0f}%',
                        filter: {
                            property: 'percentage',
                            operator: '>',
                            value: 4 // 5% ì´í•˜ ë¼ë²¨ ìˆ¨ê¹€
                        },
                        style: {
                            textOutline: 'none',
                            color: '#fff',
                            fontWeight: 'bold',
                            textShadow: '0px 0px 3px black'
                        }
                    }
                },
                series: { borderRadius: 0 }
            },
            legend: {
                reversed: false, // 1ê¸‰ë¶€í„° ìˆœì„œëŒ€ë¡œ í‘œì‹œ
                itemStyle: { color: 'var(--color-text)', fontWeight: 'bold' },
                itemHoverStyle: { color: 'var(--color-primary)' }
            },
            credits: { enabled: false },
            series: seriesData
        });
    }

    // [New] Render Absolute Bar Chart (Frequency)
    function renderAbsoluteChart(fileStats) {
        if (!fileStats || fileStats.length === 0) return;

        // Xì¶• ì¹´í…Œê³ ë¦¬ (íŒŒì¼ëª…)
        const categories = fileStats.map(item => {
            const name = item.filename;
            return name.length > 15 ? name.substring(0, 15) + '...' : name;
        });

        // 1ê¸‰ ~ 6ê¸‰ + ë“±ê¸‰ ì—†ìŒ ì‹œë¦¬ì¦ˆ ë°ì´í„° êµ¬ì„± (ë“±ê¸‰ ì—†ìŒ í¬í•¨)
        const gradeKeys = ['1ê¸‰', '2ê¸‰', '3ê¸‰', '4ê¸‰', '5ê¸‰', '6ê¸‰', 'ë“±ê¸‰ ì—†ìŒ'];
        const gradeColors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#64748b', '#94a3b8'];

        const seriesData = gradeKeys.map((key, index) => {
            return {
                name: key,
                color: gradeColors[index],
                data: fileStats.map(item => item.stats[key] || 0) // ê° íŒŒì¼ë³„ í•´ë‹¹ ê¸‰ìˆ˜ ë¹ˆë„
            };
        });

        absoluteChartInstance = Highcharts.chart('fileAbsoluteChart', {
            chart: {
                type: 'bar', // ê°€ë¡œ ë§‰ëŒ€ ê·¸ë˜í”„
                backgroundColor: 'transparent',
                style: { fontFamily: 'var(--font-family)' }
            },
            title: { text: '' },
            xAxis: {
                categories: categories,
                title: { text: null },
                labels: {
                    style: {
                        color: 'var(--color-text)', // ë‹¤í¬ëª¨ë“œ ëŒ€ì‘
                        fontSize: '14px',
                        fontWeight: '500'
                    }
                },
                lineWidth: 0,
                tickWidth: 0
            },
            yAxis: {
                min: 0,
                // ì ˆëŒ€ë¹ˆë„ì´ë¯€ë¡œ max 100 ì•„ë‹˜
                title: {
                    text: 'ë‹¨ì–´ ìˆ˜ (ê°œ)',
                    align: 'high',
                    style: { color: 'var(--color-text-muted)' }
                },
                labels: {
                    overflow: 'justify',
                    style: { color: 'var(--color-text-muted)' }
                },
                reversedStacks: false
            },
            tooltip: {
                pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}ê°œ</b><br/>',
                shared: true,
                backgroundColor: 'var(--color-card-bg)',
                borderColor: 'var(--color-card-border)',
                style: { color: 'var(--color-text)' }
            },
            plotOptions: {
                bar: {
                    stacking: 'normal', // [ì¤‘ìš”] ì ˆëŒ€ê°’ ëˆ„ì 
                    groupPadding: 0.02,
                    pointPadding: 0.02,
                    borderWidth: 0,
                    dataLabels: {
                        enabled: true,
                        format: '{point.y}', // ê°œìˆ˜ í‘œì‹œ
                        filter: {
                            property: 'y',
                            operator: '>',
                            value: 0 // 0ë³´ë‹¤ í´ ë•Œë§Œ í‘œì‹œ
                        },
                        style: {
                            textOutline: 'none',
                            color: '#fff',
                            fontWeight: 'bold',
                            textShadow: '0px 0px 3px black'
                        }
                    }
                },
                series: { borderRadius: 0 }
            },
            legend: {
                reversed: false,
                itemStyle: { color: 'var(--color-text)', fontWeight: 'bold' },
                itemHoverStyle: { color: 'var(--color-primary)' }
            },
            credits: { enabled: false },
            series: seriesData
        });
    }


    // [New] Toggle Pie Chart Mode (Integrated vs Individual)
    window.togglePieMode = function (mode) {
        const integratedArea = document.getElementById('integrated-chart-area');
        const individualArea = document.getElementById('individual-charts-container');
        const sharedLegend = document.getElementById('shared-pie-legend');

        if (mode === 'integrated') {
            integratedArea.style.display = 'block';
            individualArea.style.display = 'none';
            if (sharedLegend) sharedLegend.style.display = 'none';
        } else {
            integratedArea.style.display = 'none';
            individualArea.style.display = 'grid';
            if (sharedLegend) sharedLegend.style.display = 'flex';

            // Re-flow charts inside grid to ensure correct size
            // (Highcharts sometimes needs reflow when container becomes visible)
            Highcharts.charts.forEach(chart => {
                if (chart && chart.options.chart.type === 'pie') {
                    chart.reflow();
                }
            });
        }
    };

    // [New] Render Shared Legend
    function renderSharedLegend() {
        const container = document.getElementById('shared-pie-legend');
        if (!container) return;

        container.innerHTML = '';
        const gradeKeys = ['1ê¸‰', '2ê¸‰', '3ê¸‰', '4ê¸‰', '5ê¸‰', '6ê¸‰', 'ë“±ê¸‰ ì—†ìŒ'];
        const gradeColors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#64748b', '#94a3b8'];

        gradeKeys.forEach((key, index) => {
            const btn = document.createElement('div');
            btn.className = 'shared-legend-item';
            // Styling to mimic Highcharts legend
            btn.style.cursor = 'pointer';
            btn.style.display = 'flex';
            btn.style.alignItems = 'center';
            btn.style.gap = '6px';
            btn.style.color = 'var(--color-text)';
            btn.style.fontSize = '14px';
            btn.style.fontWeight = 'bold';
            btn.style.opacity = '1';
            btn.style.transition = 'opacity 0.2s';
            btn.dataset.seriesName = key;
            btn.onclick = () => window.toggleSharedSeries(key, btn);

            const indicator = document.createElement('span');
            indicator.style.display = 'inline-block';
            indicator.style.width = '12px';
            indicator.style.height = '12px';
            indicator.style.borderRadius = '50%';
            indicator.style.backgroundColor = gradeColors[index];

            const text = document.createElement('span');
            text.innerText = key;

            btn.appendChild(indicator);
            btn.appendChild(text);
            container.appendChild(btn);
        });
    }

    // [New] Toggle Shared Series Logic
    window.toggleSharedSeries = function (seriesName, btnElement) {
        // Toggle visual state of button
        const isHidden = btnElement.style.opacity === '0.5';
        btnElement.style.opacity = isHidden ? '1' : '0.5';
        const setVisible = isHidden; // If it was hidden, make it visible

        // Iterate all charts and toggle the specific slice
        // Note: For Pie charts in Highcharts, each slice is a 'point' in one series.
        // We need to find the point with name == seriesName.

        Highcharts.charts.forEach(chart => {
            // Check if this is one of our mini-pies (you might want a better check if there are other charts)
            // We can check container ID prefix
            if (chart && chart.renderTo.id.startsWith('mini-pie-')) {
                if (chart.series[0]) {
                    const point = chart.series[0].points.find(p => p.name === seriesName);
                    if (point) {
                        point.setVisible(setVisible);
                    }
                }
            }
        });
    }

    // [New] Render Individual Pie Charts
    function renderIndividualCharts(fileStats) {
        const container = document.getElementById('individual-charts-container');
        if (!container) return;
        container.innerHTML = ''; // Clear existing

        if (!fileStats || fileStats.length === 0) {
            container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--color-text-muted);">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        // Render Legend ONCE
        renderSharedLegend();

        const gradeColors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#64748b', '#94a3b8']; // Added No Grade color

        fileStats.forEach((item, index) => {
            const chartDiv = document.createElement('div');
            chartDiv.id = `mini-pie-${index}`;
            chartDiv.style.width = '100%';
            chartDiv.style.height = '300px'; // Reduced height since legend is gone
            chartDiv.style.backgroundColor = 'var(--color-card-bg)';
            chartDiv.style.borderRadius = '12px';
            chartDiv.style.border = '1px solid var(--muted-border-color)';
            chartDiv.style.padding = '10px';
            container.appendChild(chartDiv);

            // ë°ì´í„° ê°€ê³µ
            const chartData = [];
            // 1~6ê¸‰
            for (let i = 1; i <= 6; i++) {
                const key = `${i}ê¸‰`;
                const count = item.stats[key] || 0;
                if (count > 0) {
                    chartData.push({
                        name: key,
                        y: count,
                        color: gradeColors[i - 1],
                        gradeIndex: i
                    });
                }
            }
            // ë“±ê¸‰ ì—†ìŒ (Always check)
            const noGradeCount = item.stats['ë“±ê¸‰ ì—†ìŒ'] || 0;
            if (noGradeCount > 0) {
                chartData.push({
                    name: 'ë“±ê¸‰ ì—†ìŒ',
                    y: noGradeCount,
                    color: gradeColors[6], // #94a3b8
                    gradeIndex: 99
                });
            }

            // ì°¨íŠ¸ ë Œë”ë§
            Highcharts.chart(chartDiv.id, {
                chart: {
                    type: 'pie',
                    backgroundColor: 'transparent',
                    height: 280
                },
                title: {
                    text: item.filename,
                    style: { fontSize: '16px', fontWeight: 'bold', color: 'var(--color-text)' }
                },
                tooltip: { pointFormat: '{series.name}: <b>{point.y}ê°œ ({point.percentage:.1f}%)</b>' },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            format: '{point.name}',
                            distance: -30, // ë¼ë²¨ ì•ˆìª½ìœ¼ë¡œ
                            style: { fontSize: '12px', fontWeight: 'bold', color: '#fff', textOutline: 'none' }
                        },
                        showInLegend: false // [CHANGED] Disable per-chart legend
                    }
                },
                series: [{ name: 'ê°œìˆ˜', data: chartData }],
                credits: { enabled: false }
            });
        });
    }

    // [New] Render Overall Chart (Refactored)
    function renderOverallChart(labels, data) {
        const gradeColors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#64748b', '#94a3b8']; // Added No Grade color

        if (!labels || labels.length === 0) return;

        const chartData = [];
        labels.forEach((label, index) => {
            const count = data[index];
            if (count > 0) {
                // ë“±ê¸‰ ì—†ìŒ ì²˜ë¦¬
                if (label === 'ë“±ê¸‰ ì—†ìŒ') {
                    chartData.push({
                        name: label,
                        y: count,
                        color: gradeColors[6], // #94a3b8
                        gradeIndex: 99
                    });
                } else {
                    const gradeNum = parseInt(label.replace(/[^0-9]/g, ''));
                    // 1~6ê¸‰ë§Œ ì¶”ê°€ (í˜¹ì‹œ ëª¨ë¥¼ ì´ìƒê°’ ë°©ì§€)
                    if (gradeNum >= 1 && gradeNum <= 6) {
                        chartData.push({
                            name: label,
                            y: count,
                            color: gradeColors[gradeNum - 1],
                            gradeIndex: gradeNum
                        });
                    }
                }
            }
        });

        gradeChartInstance = Highcharts.chart('gradeChart', {
            chart: {
                type: 'pie',
                options3d: { enabled: true, alpha: 45, beta: 0 },
                backgroundColor: 'transparent',
                height: 400
            },
            title: { text: '' },
            tooltip: { pointFormat: '{series.name}: <b>{point.y}ê°œ ({point.percentage:.1f}%)</b>' },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    depth: 35,
                    dataLabels: {
                        enabled: true,
                        format: '{point.name}',
                        style: { fontSize: '20px', fontWeight: 'bold', color: 'var(--color-text)' }
                    },
                    point: {
                        events: {
                            mouseOver: function () {
                                if (this.gradeIndex === 99) return; // ë“±ê¸‰ ì—†ìŒì€ í•˜ì´ë¼ì´íŠ¸ ì œì™¸
                                const targetClass = `text-grade-${this.gradeIndex}`;
                                document.querySelectorAll(`.${targetClass}`).forEach(el => el.classList.add('highlight-active'));
                            },
                            mouseOut: function () {
                                if (this.gradeIndex === 99) return;
                                document.querySelectorAll('.interactive-word').forEach(el => el.classList.remove('highlight-active'));
                            }
                        }
                    },
                    showInLegend: true // [NEW] Legend enabled
                }
            },
            legend: {
                layout: 'horizontal',
                align: 'center',
                verticalAlign: 'bottom',
                itemStyle: { color: 'var(--color-text)', fontWeight: 'bold', fontSize: '14px' },
                itemHoverStyle: { color: 'var(--color-primary)' }
            },
            series: [{ name: 'ê°œìˆ˜', data: chartData }],
            credits: { enabled: false }
        });
    }

    // [New] Text File Filter Logic
    window.filterTextFile = function (targetId) {
        // Hide all
        const contents = document.getElementsByClassName('file-text-content');
        for (let i = 0; i < contents.length; i++) {
            contents[i].style.display = 'none';
        }

        // Show target
        const target = document.getElementById(targetId);
        if (target) {
            target.style.display = 'block';
        }
    };

    document.addEventListener('DOMContentLoaded', function () {
        loadHighcharts(function () {
            // 1. ì¢…í•© ì›ê·¸ë˜í”„ ë°ì´í„° ë¡œë“œ
            try {
                const labelsEl = document.getElementById('viz-data-labels');
                const dataEl = document.getElementById('viz-data-data');
                const fileStatsEl = document.getElementById('viz-file-stats');

                if (labelsEl && labelsEl.textContent.trim()) globalInitialLabels = JSON.parse(labelsEl.textContent);
                if (dataEl && dataEl.textContent.trim()) globalInitialData = JSON.parse(dataEl.textContent);
                if (fileStatsEl && fileStatsEl.textContent.trim()) globalFileStats = JSON.parse(fileStatsEl.textContent);

            } catch (e) {
                console.error("[visualization.html] Error parsing visualization data:", e);
            }

            // Render Overall Chart (initially without ungraded - wait, user wants legend now, so always include)
            renderOverallChart(globalInitialLabels, globalInitialData);

            // 2. íŒŒì¼ë³„ ë¹„êµ ì°¨íŠ¸ (Ratio & Absolute) + [NEW] ê°œë³„ ì›ê·¸ë˜í”„
            if (globalFileStats && globalFileStats.length > 0) {
                renderComparisonChart(globalFileStats);
                renderAbsoluteChart(globalFileStats);
                renderIndividualCharts(globalFileStats); // [NEW] ì´ˆê¸° ë Œë”ë§ (Hidden ìƒíƒœ)
            } else {
                const comparisonDiv = document.getElementById('fileComparisonChart');
                const absoluteDiv = document.getElementById('fileAbsoluteChart');
                const individualContainer = document.getElementById('individual-charts-container');
                const msg = '<p style="text-align:center; color:var(--color-text-muted); padding:2rem;">ë¹„êµí•  íŒŒì¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';

                if (comparisonDiv) comparisonDiv.innerHTML = msg;
                if (absoluteDiv) absoluteDiv.innerHTML = msg;
                if (individualContainer) individualContainer.innerHTML = msg;
            }
        });
    });
</script>

<style>
    /* Tab Styling */
    .nav-tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
        background: var(--color-card-bg);
        /* ë°°ê²½ìƒ‰ ì¼ì¹˜ */
        border-radius: 99px;
        /* ë‘¥ê·¼ ìº¡ìŠ ëª¨ì–‘ */
        padding: 0.5rem;
        border: 1px solid var(--color-card-border);
        box-shadow: var(--shadow-card);
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
    }

    .nav-tab {
        border: none;
        background: transparent;
        color: var(--color-text-muted);
        padding: 0.75rem 1.5rem;
        border-radius: 99px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .nav-tab:hover {
        color: var(--color-primary);
    }

    .nav-tab.active {
        background: var(--color-primary);
        color: #fff;
        box-shadow: 0 4px 10px rgba(168, 85, 247, 0.4);
    }

    /* Existing Styles */
    .grade-badge {
        display: inline-block;
        border-radius: 12px;
        color: #fff;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* í…Œì´ë¸” ë±ƒì§€ìš© (ë°°ê²½ìƒ‰ ìˆìŒ) */
    .grade-1 {
        background-color: #10b981;
    }

    .grade-2 {
        background-color: #3b82f6;
    }

    .grade-3 {
        background-color: #8b5cf6;
    }

    .grade-4 {
        background-color: #f59e0b;
    }

    .grade-5 {
        background-color: #ef4444;
    }

    .grade-6 {
        background-color: #64748b;
    }

    /* í…ìŠ¤íŠ¸ ì‹œê°í™”ìš© */
    .text-grade-1,
    .text-grade-2,
    .text-grade-3,
    .text-grade-4,
    .text-grade-5,
    .text-grade-6 {
        text-decoration: none;
        font-weight: 500;
    }

    .text-grade-1 {
        color: #10b981;
    }

    .text-grade-2 {
        color: #3b82f6;
    }

    .text-grade-3 {
        color: #8b5cf6;
    }

    .text-grade-4 {
        color: #f59e0b;
    }

    .text-grade-5 {
        color: #ef4444;
    }

    .text-grade-6 {
        color: #64748b;
    }

    /* ê°•ì¡° íš¨ê³¼ */
    .highlight-active {
        font-weight: 900 !important;
        text-decoration: underline;
        text-decoration-thickness: 3px;
        transform: scale(1.1);
        display: inline-block;
        transition: all 0.2s ease;
    }
</style>