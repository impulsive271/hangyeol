<!-- [NEW] ì‹œê°í™” ì„¹ì…˜ (ì›ê·¸ë˜í”„ + í•˜ì´ë¼ì´íŠ¸ ì›ë¬¸ + íŒŒì¼ë³„ ë¹„êµ) -->
<hr style="margin: 3rem 0; border-color: var(--muted-border-color);">

<div class="visualization-container" style="display: flex; flex-direction: column; gap: 2rem;">

    <!-- 1. íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="openVizTab(event, 'tab-overall')">ì¢…í•© ë¶„í¬</button>
        <button class="nav-tab" onclick="openVizTab(event, 'tab-comparison')">ë¹„ìœ¨ë§‰ëŒ€ê·¸ë¦¼</button>
    </div>

    <!-- 2. íƒ­ ì½˜í…ì¸  ì˜ì—­ -->
    <div class="tab-content-container">

        <!-- Tab 1: ì¢…í•© ë¶„í¬ (ê¸°ì¡´ ì›ê·¸ë˜í”„) -->
        <div id="tab-overall" class="viz-tab-pane active" style="display: block;">
            <h3 style="margin-bottom: 1rem; font-weight: 700;">ğŸ° ì¢…í•© ë“±ê¸‰ ë¶„í¬</h3>
            <div style="max-width: 500px; margin: 0 auto;">
                <div id="gradeChart"></div>
            </div>
        </div>

        <!-- Tab 2: íŒŒì¼ë³„ ë¹„êµ (ëˆ„ì  ë§‰ëŒ€ ê·¸ë˜í”„) -->
        <div id="tab-comparison" class="viz-tab-pane" style="display: none;">
            <h3 style="margin-bottom: 1rem; font-weight: 700;">ğŸ“Š íŒŒì¼ë³„ í…ìŠ¤íŠ¸ ì–´íœ˜ ë“±ê¸‰ ë¶„í¬ ë¹„êµ</h3>
            <p style="color: var(--color-text-muted); font-size: 0.9rem; margin-bottom: 1rem; text-align: center;">
                * ê° í…ìŠ¤íŠ¸ íŒŒì¼ ë‚´ ì–´íœ˜ ë“±ê¸‰ ë¹„ìœ¨ì„ í•œëˆˆì— ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <div id="fileComparisonChart" style="width: 100%; height: 500px;"></div>

            <!-- [NEW] ë“±ê¸‰ ì—†ìŒ í¬í•¨ ì²´í¬ë°•ìŠ¤ -->
            <div style="text-align: right; margin-top: 10px;">
                <label
                    style="cursor: pointer; font-size: 0.95rem; user-select: none; display: inline-flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="include-ungraded-toggle" onchange="toggleUngradedSeries(this)">
                    <span>'ë“±ê¸‰ ì—†ìŒ' í¬í•¨í•˜ì—¬ ë³´ê¸°</span>
                </label>
            </div>
        </div>

    </div>

    <!-- 3. í•˜ì´ë¼ì´íŠ¸ ì›ë¬¸ ì˜ì—­ (ê³µí†µ) -->
    <div style="margin-top: 1rem;">
        <h3 style="margin-bottom: 1rem; font-weight: 700;">ğŸ“ ì‹œê°í™”ëœ ì›ë¬¸</h3>
        <p style="color: var(--color-text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
            * ê·¸ë˜í”„ì˜ ê° ì¡°ê°ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ í•´ë‹¹ ë“±ê¸‰ì˜ ë‹¨ì–´ê°€ ê°•ì¡°ë©ë‹ˆë‹¤.
        </p>
        <div id="highlighted-text-box"
            style="padding: 1.5rem; border-radius: 12px; line-height: 2.0; font-size: 1.2rem; border: 1px solid var(--muted-border-color);">
            {% for seg in text_segments %}
            {% if seg.type == 'graded' %}
            <span class="interactive-word {{ seg.class }}" data-grade="{{ seg.class }}"
                data-offset="{{ seg.info.offset_start }}" data-ui-id="{{ seg.info._ui_id }}"
                data-tooltip="{{ seg.info.level }} - {{ seg.info.desc }}">
                {{ seg.text }}
            </span>
            {% else %}
            <span>{{ seg.text }}</span>
            {% endif %}
            {% endfor %}
        </div>
    </div>

</div>

<!-- Data Passing (Safe Pattern) -->
<script id="viz-data-labels" type="application/json">
    {{ visualization_data.labels | tojson | default('[]') }}
</script>
<script id="viz-data-data" type="application/json">
    {{ visualization_data.data | tojson | default('[]') }}
</script>
<script id="viz-file-stats" type="application/json">
    {{ file_stats_list | tojson | default('[]') }}
</script>

<!-- Highcharts ë¡œë“œ í™•ì¸ ë° ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ -->
<script>
    console.log("[visualization.html] Script loaded (Safe Pattern).");

    // Highcharts ë¡œë“œ ì—¬ë¶€ ì²´í‚¹ í•¨ìˆ˜
    function loadHighcharts(callback) {
        if (window.Highcharts && window.Highcharts.chart) {
            callback();
            return;
        }
        // Highchartsê°€ ì—†ìœ¼ë©´ ë™ì  ë¡œë“œ (CDN)
        const scriptMain = document.createElement('script');
        scriptMain.src = 'https://code.highcharts.com/highcharts.js';
        scriptMain.onload = function () {
            const script3d = document.createElement('script');
            script3d.src = 'https://code.highcharts.com/highcharts-3d.js';
            script3d.onload = callback; // 3D ëª¨ë“ˆ ë¡œë“œ í›„ ì½œë°± ì‹¤í–‰
            document.head.appendChild(script3d);
        };
        document.head.appendChild(scriptMain);
    }

    let gradeChartInstance = null; // Donut Chart instance
    let comparisonChartInstance = null; // Bar Chart instance

    // íƒ­ ì „í™˜ í•¨ìˆ˜
    window.openVizTab = function (evt, tabId) {
        // 1. ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¹€
        const tabContents = document.getElementsByClassName("viz-tab-pane");
        for (let i = 0; i < tabContents.length; i++) {
            tabContents[i].style.display = "none";
        }

        // 2. ëª¨ë“  íƒ­ ë²„íŠ¼ active í´ë˜ìŠ¤ ì œê±°
        const tabLinks = document.getElementsByClassName("nav-tab");
        for (let i = 0; i < tabLinks.length; i++) {
            tabLinks[i].className = tabLinks[i].className.replace(" active", "");
        }

        // 3. ì„ íƒëœ íƒ­ ë³´ì´ê¸° ë° active í´ë˜ìŠ¤ ì¶”ê°€
        document.getElementById(tabId).style.display = "block";
        evt.currentTarget.className += " active";

        // 4. ì°¨íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ (ìˆ¨ê²¨ì ¸ ìˆë˜ ì°¨íŠ¸ëŠ” ì‚¬ì´ì¦ˆê°€ ê¹¨ì§ˆ ìˆ˜ ìˆìŒ)
        if (tabId === 'tab-comparison' && comparisonChartInstance) {
            comparisonChartInstance.reflow();
        } else if (tabId === 'tab-overall' && gradeChartInstance) {
            gradeChartInstance.reflow();
        }
    };

    // Global function to refresh chart from table data (Legacy support for Donut)
    window.refreshGradeChart = function () {
        console.log("[refreshGradeChart] Called.");
        // (ê¸°ì¡´ ë¡œì§ ìœ ì§€ - ë¶„ì„ í…Œì´ë¸”ì—ì„œ ë°ì´í„° ì½ì–´ì„œ ì›ê·¸ë˜í”„ ì—…ë°ì´íŠ¸)
        // ... (í•„ìš” ì‹œ ìœ ì§€, ë³µì¡ì„±ì„ ì¤„ì´ê¸° ìœ„í•´ ì¼ë‹¨ ê¸°ì¡´ ë¡œì§ í™œìš©)
        if (!gradeChartInstance) return;

        // ... ê¸°ì¡´ refreshGradeChart ë¡œì§ ë³µì‚¬ ...
        const gradeCounts = { '1ê¸‰': 0, '2ê¸‰': 0, '3ê¸‰': 0, '4ê¸‰': 0, '5ê¸‰': 0, '6ê¸‰': 0 };
        const rows = document.querySelectorAll('#analysis-table tbody tr');
        let maxGrade = 0;
        if (rows.length === 0) return;
        rows.forEach(row => {
            const gradeBadge = row.querySelector('.grade-badge');
            if (gradeBadge) {
                const gradeText = gradeBadge.innerText.trim();
                if (gradeCounts[gradeText] !== undefined) {
                    gradeCounts[gradeText]++;
                    const levelNum = parseInt(gradeText.replace('ê¸‰', ''));
                    if (levelNum > maxGrade) maxGrade = levelNum;
                }
            }
        });
        const gradeColors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#64748b'];
        const chartData = [];
        Object.keys(gradeCounts).forEach((gradeKey, index) => {
            if (gradeCounts[gradeKey] > 0) {
                const gradeNum = parseInt(gradeKey.replace('ê¸‰', ''));
                chartData.push({
                    name: gradeKey,
                    y: gradeCounts[gradeKey],
                    color: gradeColors[gradeNum - 1],
                    gradeIndex: gradeNum
                });
            }
        });
        gradeChartInstance.series[0].setData(chartData);
        window.updateOverallGrade(maxGrade);
    };

    window.updateOverallGrade = function (maxGrade) {
        const gradeText = maxGrade > 0 ? `${maxGrade}ê¸‰` : 'ë¶„ì„ë¶ˆê°€';
        const overallText = document.getElementById('overall-grade-text');
        if (overallText) overallText.innerText = gradeText;
        const overallBadge = document.getElementById('overall-grade-badge');
        if (overallBadge) {
            overallBadge.className = `grade-badge grade-${maxGrade}`;
            overallBadge.innerText = `ìµœì¢…: ${gradeText}`;
        }
    };

    // [New] Toggle Ungraded Series
    window.toggleUngradedSeries = function (checkbox) {
        if (!comparisonChartInstance) return;

        // 'ë“±ê¸‰ ì—†ìŒ' ì‹œë¦¬ì¦ˆ ì°¾ê¸° (ì¸ë±ìŠ¤ë‚˜ ì´ë¦„ìœ¼ë¡œ)
        // ì´ë¦„ 'ë“±ê¸‰ ì—†ìŒ' ì‹œë¦¬ì¦ˆë¥¼ ì°¾ì•„ì„œ ë³´ì—¬ì£¼ê±°ë‚˜ ìˆ¨ê¹€
        const ungradedSeries = comparisonChartInstance.series.find(s => s.name === 'ë“±ê¸‰ ì—†ìŒ');
        if (ungradedSeries) {
            ungradedSeries.setVisible(checkbox.checked);
        }
    };

    // [New] Render Comparison Chart
    function renderComparisonChart(fileStats) {
        if (!fileStats || fileStats.length === 0) return;

        // Xì¶• ì¹´í…Œê³ ë¦¬ (íŒŒì¼ëª…)
        const categories = fileStats.map(item => {
            // íŒŒì¼ëª…ì´ ë„ˆë¬´ ê¸¸ë©´ ... ì²˜ë¦¬
            const name = item.filename;
            return name.length > 15 ? name.substring(0, 15) + '...' : name;
        });

        // 1ê¸‰ ~ 6ê¸‰ + ë“±ê¸‰ ì—†ìŒ ì‹œë¦¬ì¦ˆ ë°ì´í„° êµ¬ì„±
        const gradeKeys = ['1ê¸‰', '2ê¸‰', '3ê¸‰', '4ê¸‰', '5ê¸‰', '6ê¸‰', 'ë“±ê¸‰ ì—†ìŒ'];
        const gradeColors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#64748b', '#94a3b8'];

        const seriesData = gradeKeys.map((key, index) => {
            return {
                name: key,
                color: gradeColors[index],
                data: fileStats.map(item => item.stats[key] || 0), // ê° íŒŒì¼ë³„ í•´ë‹¹ ê¸‰ìˆ˜ ë¹ˆë„
                visible: key !== 'ë“±ê¸‰ ì—†ìŒ' // 'ë“±ê¸‰ ì—†ìŒ'ì€ ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ (ì²´í¬ë°•ìŠ¤ë¡œ ì œì–´)
            };
        });

        comparisonChartInstance = Highcharts.chart('fileComparisonChart', {
            chart: {
                type: 'bar', // ê°€ë¡œ ë§‰ëŒ€ ê·¸ë˜í”„
                backgroundColor: 'transparent',
                style: {
                    fontFamily: 'var(--font-family)'
                }
            },
            title: { text: '' },
            xAxis: {
                categories: categories,
                title: { text: null },
                labels: {
                    style: {
                        color: 'var(--color-text)', // ë‹¤í¬ëª¨ë“œ ëŒ€ì‘
                        fontSize: '14px',
                        fontWeight: '500'
                    }
                },
                lineWidth: 0,
                tickWidth: 0
            },
            yAxis: {
                min: 0,
                max: 100, // 100% ê½‰ ì°¨ê²Œ
                title: {
                    text: 'ë¹„ìœ¨ (%)',
                    align: 'high',
                    style: { color: 'var(--color-text-muted)' }
                },
                labels: {
                    overflow: 'justify',
                    style: { color: 'var(--color-text-muted)' }
                },
                reversedStacks: false // [í•µì‹¬] 1ê¸‰ì´ ì™¼ìª½(ì¶• ì‹œì‘ì )ì— ì˜¤ë„ë¡ ì„¤ì •
            },
            tooltip: {
                pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.percentage:.1f}%)<br/>',
                shared: true,
                backgroundColor: 'var(--color-card-bg)', // íˆ´íŒ ë°°ê²½ë„ í…Œë§ˆ ì ìš©
                borderColor: 'var(--color-card-border)',
                style: {
                    color: 'var(--color-text)'
                }
            },
            plotOptions: {
                bar: {
                    stacking: 'percent', // 100% ëˆ„ì  ë§‰ëŒ€
                    groupPadding: 0.02,   // [ìˆ˜ì •] ë§‰ëŒ€ ì‚¬ì´ ê°„ê²© ìµœì†Œí™”
                    pointPadding: 0.02,   // [ìˆ˜ì •] í¬ì¸íŠ¸ ê°„ ê°„ê²© ìµœì†Œí™”
                    borderWidth: 0,
                    dataLabels: {
                        enabled: true,
                        format: '{point.percentage:.0f}%',
                        filter: {
                            property: 'percentage',
                            operator: '>',
                            value: 4 // 5% ì´í•˜ ë¼ë²¨ ìˆ¨ê¹€
                        },
                        style: {
                            textOutline: 'none',
                            color: '#fff', // ë°” ë‚´ë¶€ ê¸€ì”¨ëŠ” í•­ìƒ í°ìƒ‰ì´ ì˜ ë³´ì„ (ë°°ê²½ìƒ‰ì´ ì§„í•˜ë¯€ë¡œ)
                            fontWeight: 'bold',
                            textShadow: '0px 0px 3px black' // ê°€ë…ì„± í™•ë³´
                        }
                    }
                },
                series: {
                    borderRadius: 0
                }
            },
            legend: {
                reversed: false, // 1ê¸‰ë¶€í„° ìˆœì„œëŒ€ë¡œ í‘œì‹œ
                itemStyle: {
                    color: 'var(--color-text)', // ë²”ë¡€ ê¸€ì”¨ ìƒ‰ìƒ
                    fontWeight: 'bold'
                },
                itemHoverStyle: {
                    color: 'var(--color-primary)'
                }
            },
            credits: { enabled: false },
            series: seriesData
        });
    }


    document.addEventListener('DOMContentLoaded', function () {
        loadHighcharts(function () {
            // 1. ì¢…í•© ì›ê·¸ë˜í”„ (ê¸°ì¡´ ë¡œì§)
            let initialLabels = [];
            let initialData = [];
            let fileStats = [];

            try {
                const labelsEl = document.getElementById('viz-data-labels');
                const dataEl = document.getElementById('viz-data-data');
                const fileStatsEl = document.getElementById('viz-file-stats');

                if (labelsEl && labelsEl.textContent.trim()) initialLabels = JSON.parse(labelsEl.textContent);
                if (dataEl && dataEl.textContent.trim()) initialData = JSON.parse(dataEl.textContent);
                if (fileStatsEl && fileStatsEl.textContent.trim()) fileStats = JSON.parse(fileStatsEl.textContent);

            } catch (e) {
                console.error("[visualization.html] Error parsing visualization data:", e);
            }

            // Render Overall Chart
            const gradeColors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#64748b'];
            if (initialLabels.length > 0) {
                const chartData = initialLabels.map((label, index) => {
                    const gradeNum = parseInt(label.replace(/[^0-9]/g, ''));
                    return {
                        name: label,
                        y: initialData[index],
                        color: gradeColors[gradeNum - 1],
                        gradeIndex: gradeNum
                    };
                });

                gradeChartInstance = Highcharts.chart('gradeChart', {
                    chart: {
                        type: 'pie',
                        options3d: { enabled: true, alpha: 45, beta: 0 },
                        backgroundColor: 'transparent',
                        height: 400
                    },
                    title: { text: '' },
                    tooltip: { pointFormat: '{series.name}: <b>{point.y}ê°œ ({point.percentage:.1f}%)</b>' },
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            depth: 35,
                            dataLabels: {
                                enabled: true,
                                format: '{point.name}',
                                style: { fontSize: '20px', fontWeight: 'bold', color: 'var(--color-text)' }
                            },
                            point: {
                                events: {
                                    mouseOver: function () {
                                        const targetClass = `text-grade-${this.gradeIndex}`;
                                        document.querySelectorAll(`.${targetClass}`).forEach(el => el.classList.add('highlight-active'));
                                    },
                                    mouseOut: function () {
                                        document.querySelectorAll('.interactive-word').forEach(el => el.classList.remove('highlight-active'));
                                    }
                                }
                            }
                        }
                    },
                    series: [{ name: 'ê°œìˆ˜', data: chartData }],
                    credits: { enabled: false }
                });
            }

            // 2. íŒŒì¼ë³„ ë¹„êµ ì°¨íŠ¸ (New)
            if (fileStats && fileStats.length > 0) {
                renderComparisonChart(fileStats);
            } else {
                const comparisonDiv = document.getElementById('fileComparisonChart');
                if (comparisonDiv) comparisonDiv.innerHTML = '<p style="text-align:center; color:var(--color-text-muted); padding:2rem;">ë¹„êµí•  íŒŒì¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        });
    });
</script>

<style>
    /* Tab Styling */
    .nav-tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
        background: var(--color-card-bg);
        /* ë°°ê²½ìƒ‰ ì¼ì¹˜ */
        border-radius: 99px;
        /* ë‘¥ê·¼ ìº¡ìŠ ëª¨ì–‘ */
        padding: 0.5rem;
        border: 1px solid var(--color-card-border);
        box-shadow: var(--shadow-card);
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
    }

    .nav-tab {
        border: none;
        background: transparent;
        color: var(--color-text-muted);
        padding: 0.75rem 1.5rem;
        border-radius: 99px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .nav-tab:hover {
        color: var(--color-primary);
    }

    .nav-tab.active {
        background: var(--color-primary);
        color: #fff;
        box-shadow: 0 4px 10px rgba(168, 85, 247, 0.4);
    }

    /* Existing Styles */
    .grade-badge {
        display: inline-block;
        border-radius: 12px;
        color: #fff;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* í…Œì´ë¸” ë±ƒì§€ìš© (ë°°ê²½ìƒ‰ ìˆìŒ) */
    .grade-1 {
        background-color: #10b981;
    }

    .grade-2 {
        background-color: #3b82f6;
    }

    .grade-3 {
        background-color: #8b5cf6;
    }

    .grade-4 {
        background-color: #f59e0b;
    }

    .grade-5 {
        background-color: #ef4444;
    }

    .grade-6 {
        background-color: #64748b;
    }

    /* í…ìŠ¤íŠ¸ ì‹œê°í™”ìš© */
    .text-grade-1,
    .text-grade-2,
    .text-grade-3,
    .text-grade-4,
    .text-grade-5,
    .text-grade-6 {
        text-decoration: none;
        font-weight: 500;
    }

    .text-grade-1 {
        color: #10b981;
    }

    .text-grade-2 {
        color: #3b82f6;
    }

    .text-grade-3 {
        color: #8b5cf6;
    }

    .text-grade-4 {
        color: #f59e0b;
    }

    .text-grade-5 {
        color: #ef4444;
    }

    .text-grade-6 {
        color: #64748b;
    }

    /* ê°•ì¡° íš¨ê³¼ */
    .highlight-active {
        font-weight: 900 !important;
        text-decoration: underline;
        text-decoration-thickness: 3px;
        transform: scale(1.1);
        display: inline-block;
        transition: all 0.2s ease;
    }
</style>