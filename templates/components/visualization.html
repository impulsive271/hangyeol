<!-- [NEW] ì‹œê°í™” ì„¹ì…˜ (ì›ê·¸ë˜í”„ + í•˜ì´ë¼ì´íŠ¸ ì›ë¬¸ + íŒŒì¼ë³„ ë¹„êµ) -->
<hr style="margin: 3rem 0; border-color: var(--muted-border-color);">

<div class="visualization-container" style="display: flex; flex-direction: column; gap: 2rem;">

    <!-- 1. íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div id="section-charts" class="nav-tabs">
        <button class="nav-tab active" onclick="openVizTab(event, 'tab-overall')">ì›ê·¸ë˜í”„</button>
        <button class="nav-tab" onclick="openVizTab(event, 'tab-comparison')">ë¹„ìœ¨ë§‰ëŒ€ê·¸ë¦¼</button>
        <button class="nav-tab" onclick="openVizTab(event, 'tab-absolute')">ë¹ˆë„ë§‰ëŒ€ê·¸ë¦¼</button>
    </div>

    <!-- 2. íƒ­ ì½˜í…ì¸  ì˜ì—­ -->
    <div class="tab-content-container">

        <!-- Tab 1: ì¢…í•© ë¶„í¬ (ê¸°ì¡´ ì›ê·¸ë˜í”„) -->
        <div id="tab-overall" class="viz-tab-pane active" style="display: block;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0; font-weight: 700;">ğŸ° ë“±ê¸‰ ë¶„í¬ ì›ê·¸ë˜í”„</h3>

                <!-- [NEW] í†µí•©/ê°œë³„ í† ê¸€ ìŠ¤ìœ„ì¹˜ -->
                <div class="toggle-container" style="font-size: 0.9rem; display: flex; align-items: center; gap: 15px;">
                    <div style="margin-right: 15px;">
                        <label style="cursor: pointer; margin-right: 10px;">
                            <input type="radio" name="pie-mode" value="integrated" checked
                                onchange="togglePieMode(this.value)">
                            í†µí•©
                        </label>
                        <label style="cursor: pointer;">
                            <input type="radio" name="pie-mode" value="individual" onchange="togglePieMode(this.value)">
                            ê°œë³„
                        </label>
                    </div>
                </div>
            </div>

            <!-- í†µí•© ì°¨íŠ¸ ì˜ì—­ -->
            <div id="integrated-chart-area" style="max-width: 500px; margin: 0 auto; display: block;">
                <div id="gradeChart"></div>
            </div>

            <!-- [NEW] Shared Legend Container (Initially Hidden) -->
            <div id="shared-pie-legend"
                style="display: none; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <!-- JS will populate this -->
            </div>

            <!-- [NEW] ê°œë³„ ì°¨íŠ¸ ì˜ì—­ (Grid Layout) -->
            <div id="individual-charts-container"
                style="display: none; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                <!-- JSë¡œ ë™ì  ìƒì„±ë¨ -->
            </div>
        </div>

        <!-- Tab 2: íŒŒì¼ë³„ ë¹„êµ (ëˆ„ì  ë¹„ìœ¨) -->
        <div id="tab-comparison" class="viz-tab-pane" style="display: none;">
            <h3 style="margin-bottom: 1rem; font-weight: 700;">ğŸ“Š íŒŒì¼ë³„ í…ìŠ¤íŠ¸ ì–´íœ˜ ë“±ê¸‰ ë¶„í¬ ë¹„êµ (ë¹„ìœ¨)</h3>
            <p style="color: var(--color-text-muted); font-size: 0.9rem; margin-bottom: 1rem; text-align: center;">
                * ê° í…ìŠ¤íŠ¸ íŒŒì¼ ë‚´ ì–´íœ˜ ë“±ê¸‰ ë¹„ìœ¨ì„ í•œëˆˆì— ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <div id="fileComparisonChart" style="width: 100%; height: 500px;"></div>

            <!-- ë“±ê¸‰ ì—†ìŒ í¬í•¨ ì²´í¬ë°•ìŠ¤ -->
            <div style="text-align: right; margin-top: 10px;">
                <label
                    style="cursor: pointer; font-size: 0.95rem; user-select: none; display: inline-flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="include-ungraded-toggle" onchange="toggleUngradedSeries(this)">
                    <span>'ë“±ê¸‰ ì—†ìŒ' í¬í•¨í•˜ì—¬ ë³´ê¸°</span>
                </label>
            </div>
        </div>

        <!-- Tab 3: íŒŒì¼ë³„ ë¹„êµ (ì ˆëŒ€ ë¹ˆë„) -->
        <div id="tab-absolute" class="viz-tab-pane" style="display: none;">
            <h3 style="margin-bottom: 1rem; font-weight: 700;">ğŸ“ˆ íŒŒì¼ë³„ ì–´íœ˜ ë¹ˆë„ìˆ˜ ë¹„êµ (ì ˆëŒ€ë¹ˆë„)</h3>
            <p style="color: var(--color-text-muted); font-size: 0.9rem; margin-bottom: 1rem; text-align: center;">
                * ê° í…ìŠ¤íŠ¸ íŒŒì¼ì˜ ì „ì²´ ë‹¨ì–´ ìˆ˜ì™€ ë“±ê¸‰ë³„ ë‹¨ì–´ ìˆ˜ë¥¼ ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <div id="fileAbsoluteChart" style="width: 100%; height: 500px;"></div>
        </div>

    </div>

    <!-- 3. í•˜ì´ë¼ì´íŠ¸ ì›ë¬¸ ì˜ì—­ (ê³µí†µ) -->
    <div style="margin-top: 1rem;">
        <h3 id="section-text" style="margin-bottom: 1rem; font-weight: 700;">ğŸ“ ì‹œê°í™”ëœ ì›ë¬¸</h3>

        <!-- [NEW] íŒŒì¼ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
        {% if file_text_contents and file_text_contents|length > 1 %}
        <div style="margin-bottom: 1rem; text-align: right;">
            <select id="text-file-select" onchange="filterTextFile(this.value)"
                style="padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--muted-border-color); background-color: var(--color-card-bg); color: var(--color-text); font-size: 1rem;">
                {% for file_item in file_text_contents %}
                <option value="file-content-{{ loop.index }}">{{ file_item.filename }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <div id="highlighted-text-box"
            style="padding: 1.5rem; border-radius: 12px; line-height: 2.0; font-size: 1.2rem; border: 1px solid var(--muted-border-color); max-height: 500px; overflow-y: auto;">

            {% if file_text_contents %}
            {% for file_item in file_text_contents %}
            <div id="file-content-{{ loop.index }}" class="file-text-content {{ 'active' if loop.first else '' }}">
                {% for seg in file_item.segments %}
                {% if seg.type == 'graded' %}
                <span class="interactive-word {{ seg.class }}" data-grade="{{ seg.class }}"
                    data-offset="{{ seg.info.offset_start }}" data-ui-id="{{ seg.info._ui_id }}"
                    data-tooltip="{{ seg.info.level }} - {{ seg.info.desc }}" style="cursor: pointer;">
                    {{ seg.text }}
                </span>
                {% else %}
                <span>{{ seg.text }}</span>
                {% endif %}
                {% endfor %}
            </div>
            {% endfor %}
            {% else %}
            <p style="color: var(--color-text-muted);">ì‹œê°í™”í•  í…ìŠ¤íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
        </div>
    </div>

</div>

<!-- Data Passing (Safe Pattern) -->
<script id="viz-data-labels" type="application/json">
    {{ visualization_data.labels | tojson | default('[]') }}
</script>
<script id="viz-data-data" type="application/json">
    {{ visualization_data.data | tojson | default('[]') }}
</script>
<script id="viz-file-stats" type="application/json">
    {{ file_stats_list | default([]) | tojson }}
</script>

<!-- Highcharts ë¡œë“œ í™•ì¸ ë° ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ -->
<script>
    console.log("[visualization.html] Script loaded (Safe Pattern).");

    // Highcharts ë¡œë“œ ì—¬ë¶€ ì²´í‚¹ í•¨ìˆ˜
    function loadHighcharts(callback) {
        if (window.Highcharts && window.Highcharts.chart) {
            callback();
            return;
        }
        // Highchartsê°€ ì—†ìœ¼ë©´ ë™ì  ë¡œë“œ (CDN)
        const scriptMain = document.createElement('script');
        scriptMain.src = 'https://code.highcharts.com/highcharts.js';
        scriptMain.onload = function () {
            const script3d = document.createElement('script');
            script3d.src = 'https://code.highcharts.com/highcharts-3d.js';
            script3d.onload = callback; // 3D ëª¨ë“ˆ ë¡œë“œ í›„ ì½œë°± ì‹¤í–‰
            document.head.appendChild(script3d);
        };
        document.head.appendChild(scriptMain);
    }

    let gradeChartInstance = null; // Donut Chart instance
    let comparisonChartInstance = null; // Ratio Bar Chart instance
    let absoluteChartInstance = null; // Absolute Bar Chart instance

    // [New] Global Data Variables
    let globalInitialLabels = [];
    let globalInitialData = [];
    let globalFileStats = [];

    // íƒ­ ì „í™˜ í•¨ìˆ˜
    window.openVizTab = function (evt, tabId) {
        // 1. ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¹€
        const tabContents = document.getElementsByClassName("viz-tab-pane");
        for (let i = 0; i < tabContents.length; i++) {
            tabContents[i].style.display = "none";
        }

        // 2. ëª¨ë“  íƒ­ ë²„íŠ¼ active í´ë˜ìŠ¤ ì œê±°
        const tabLinks = document.getElementsByClassName("nav-tab");
        for (let i = 0; i < tabLinks.length; i++) {
            tabLinks[i].className = tabLinks[i].className.replace(" active", "");
        }

        // 3. ì„ íƒëœ íƒ­ ë³´ì´ê¸° ë° active í´ë˜ìŠ¤ ì¶”ê°€
        document.getElementById(tabId).style.display = "block";
        evt.currentTarget.className += " active";

        // 4. ì°¨íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ (ìˆ¨ê²¨ì ¸ ìˆë˜ ì°¨íŠ¸ëŠ” ì‚¬ì´ì¦ˆê°€ ê¹¨ì§ˆ ìˆ˜ ìˆìŒ)
        if (tabId === 'tab-comparison' && comparisonChartInstance) {
            comparisonChartInstance.reflow();
        } else if (tabId === 'tab-overall' && gradeChartInstance) {
            gradeChartInstance.reflow();
        } else if (tabId === 'tab-absolute' && absoluteChartInstance) {
            absoluteChartInstance.reflow();
        }
        // ê°œë³„ ì°¨íŠ¸ë„ ë¦¬ì‚¬ì´ì¦ˆ
        if (tabId === 'tab-overall') {
            const individualContainer = document.getElementById('individual-charts-container');
            if (individualContainer.style.display !== 'none') {
                Highcharts.charts.forEach(chart => {
                    if (chart && chart.options.chart.type === 'pie') {
                        chart.reflow();
                    }
                });
            }
        }
    };

    // [MODIFIED] Global function to refresh chart AND FREQUENCY TABLE from table data
    window.refreshGradeChart = function () {
        // 1. Recalculate Stats from Main Analysis Table
        const tableBody = document.querySelector('#analysis-table tbody');
        if (!tableBody) return;

        // Reset counts
        const stats = {
            '1ê¸‰': 0, '2ê¸‰': 0, '3ê¸‰': 0, '4ê¸‰': 0, '5ê¸‰': 0, '6ê¸‰': 0,
            'ë“±ê¸‰ ì—†ìŒ': 0, 'ê¸°íƒ€': 0, 'ì „ì²´': 0
        };

        const rows = Array.from(tableBody.querySelectorAll('tr'));
        rows.forEach(row => {
            const gradeCell = row.querySelector('.cell-grade');
            if (gradeCell) {
                const gradeText = gradeCell.innerText.trim();
                // Extract number or 'ë“±ê¸‰ ì—†ìŒ'
                if (gradeText.includes('ë“±ê¸‰ ì—†ìŒ') || gradeText === '-') {
                    stats['ë“±ê¸‰ ì—†ìŒ']++;
                } else if (gradeText.includes('ê¸‰')) {
                    // e.g., "1ê¸‰"
                    const match = gradeText.match(/(\d)ê¸‰/);
                    if (match && stats[`${match[1]}ê¸‰`] !== undefined) {
                        stats[`${match[1]}ê¸‰`]++;
                    } else {
                        stats['ê¸°íƒ€']++; // Should catch undefined grades
                    }
                } else {
                    stats['ê¸°íƒ€']++;
                }
                stats['ì „ì²´']++;
            }
        });

        // 2. Update Charts (Pie Chart)
        // Filter out zero-value slices for cleaner chart
        const newSeriesData = [
            { name: '1ê¸‰', y: stats['1ê¸‰'], color: '#10b981' },
            { name: '2ê¸‰', y: stats['2ê¸‰'], color: '#3b82f6' },
            { name: '3ê¸‰', y: stats['3ê¸‰'], color: '#8b5cf6' },
            { name: '4ê¸‰', y: stats['4ê¸‰'], color: '#f59e0b' },
            { name: '5ê¸‰', y: stats['5ê¸‰'], color: '#ef4444' },
            { name: '6ê¸‰', y: stats['6ê¸‰'], color: '#64748b' },
            { name: 'ë“±ê¸‰ ì—†ìŒ', y: stats['ë“±ê¸‰ ì—†ìŒ'], color: '#94a3b8' }
        ].filter(item => item.y > 0); // [NEW] Filter: Only show items with count > 0

        // Update Grade Chart (Pie)
        if (gradeChartInstance) {
            gradeChartInstance.series[0].setData(newSeriesData, true);
        }

        // Also update comparison/absolute charts if they exist and logic allows (omitted for now to focus on request)

        // 3. Update Frequency Table
        // Need to re-aggregate per filename since the table shows per-file stats.
        const fileStats = {};

        rows.forEach(row => {
            const filename = row.querySelector('.cell-filename').innerText.trim();
            if (!fileStats[filename]) {
                fileStats[filename] = {
                    '1ê¸‰': 0, '2ê¸‰': 0, '3ê¸‰': 0, '4ê¸‰': 0, '5ê¸‰': 0, '6ê¸‰': 0,
                    'ë“±ê¸‰ ì—†ìŒ': 0, 'ê¸°íƒ€': 0, 'ì „ì²´': 0
                };
            }

            const gradeCell = row.querySelector('.cell-grade');
            const gradeText = gradeCell.innerText.trim();

            if (gradeText.includes('ë“±ê¸‰ ì—†ìŒ') || gradeText === '-') {
                fileStats[filename]['ë“±ê¸‰ ì—†ìŒ']++;
            } else {
                const match = gradeText.match(/(\d)ê¸‰/);
                if (match) fileStats[filename][`${match[1]}ê¸‰`]++;
                else fileStats[filename]['ê¸°íƒ€']++;
            }
            fileStats[filename]['ì „ì²´']++;
        });

        // Update the HTML Table directly
        const freqTable = document.getElementById('frequency-table');

        if (freqTable) {
            const tbody = freqTable.querySelector('tbody');
            Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
                const fnameCell = tr.querySelector('td:first-child');
                const fname = fnameCell.innerText.trim();

                if (fileStats[fname]) {
                    const s = fileStats[fname];
                    const cells = tr.querySelectorAll('td');
                    // 0: Filename
                    cells[1].innerText = s['1ê¸‰'];
                    cells[2].innerText = s['2ê¸‰'];
                    cells[3].innerText = s['3ê¸‰'];
                    cells[4].innerText = s['4ê¸‰'];
                    cells[5].innerText = s['5ê¸‰'];
                    cells[6].innerText = s['6ê¸‰'];
                    cells[7].innerText = s['ë“±ê¸‰ ì—†ìŒ'];
                    cells[8].innerText = s['ê¸°íƒ€'];
                    cells[9].innerText = s['ì „ì²´'];
                }
            });
        }

        // 4. Update Overall Grade Badge
        let maxCount = 0;
        let maxGrade = 0;
        // Grade precedence logic? Or just most frequent?
        // Usually 'Overall Grade' is weighted average or most frequent.
        // Existing logic: window.updateOverallGrade(maxGrade)
        // Let's find dominant grade.
        for (let g = 1; g <= 6; g++) {
            if (stats[`${g}ê¸‰`] > maxCount) {
                maxCount = stats[`${g}ê¸‰`];
                maxGrade = g;
            }
        }
        window.updateOverallGrade(maxGrade);
    };

    window.updateOverallGrade = function (maxGrade) {
        const gradeText = maxGrade > 0 ? `${maxGrade}ê¸‰` : 'ë¶„ì„ë¶ˆê°€';
        const overallText = document.getElementById('overall-grade-text');
        if (overallText) overallText.innerText = gradeText;
        const overallBadge = document.getElementById('overall-grade-badge');
        if (overallBadge) {
            overallBadge.className = `grade-badge grade-${maxGrade}`;
            overallBadge.innerText = `ìµœì¢…: ${gradeText}`;
        }
    };

    // [New] Text Click Navigation
    document.addEventListener('DOMContentLoaded', function () {
        const textBox = document.getElementById('highlighted-text-box');
        if (textBox) {
            textBox.addEventListener('click', function (e) {
                const target = e.target.closest('.interactive-word');
                if (target && target.dataset.uiId) {
                    scrollToRow(target.dataset.uiId);
                }
            });
        }
    });

    function scrollToRow(uiId) {
        const row = document.getElementById(uiId);
        if (row) {
            // 1. Scroll
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // 2. Reset (remove classes)
            row.classList.remove('highlight-start');
            row.classList.remove('highlight-fade');

            // 3. Force Reflow
            void row.offsetWidth;

            // 4. Start Highlight (Instant Color)
            row.classList.add('highlight-start');

            // 5. Trigger Fade (After 2 seconds hold)
            setTimeout(() => {
                row.classList.add('highlight-fade');
            }, 2000);

            // 6. Cleanup (Total 3s: 2s hold + 1s fade)
            setTimeout(() => {
                row.classList.remove('highlight-start');
                row.classList.remove('highlight-fade');
            }, 3050); // 3000ms + buffer
        }
    }

    // [New] Toggle Ungraded Series (Bar Chart)
    window.toggleUngradedSeries = function (checkbox) {
        if (!comparisonChartInstance) return;

        // 'ë“±ê¸‰ ì—†ìŒ' ì‹œë¦¬ì¦ˆ ì°¾ê¸°
        const ungradedSeries = comparisonChartInstance.series.find(s => s.name === 'ë“±ê¸‰ ì—†ìŒ');
        if (ungradedSeries) {
            ungradedSeries.setVisible(checkbox.checked);
        }
    };

    // [New] Update Single Visualized Text (Existing)
    window.updateVisualizedText = function (offset, gradeStr, desc, newText, originalText, uiId) {
        // Try to find by UI ID first (Robust)
        let target = null;
        if (uiId) {
            target = document.querySelector(`.interactive-word[data-ui-id="${uiId}"]`);
        }

        // Fallback by offset if needed (though UI ID is preferred)
        if (!target) {
            // ... implementation if needed, but UI ID should suffice
            console.warn("Could not find visualization element with UI ID:", uiId);
            return;
        }

        // Update Text
        target.innerText = newText;

        // Update Class (Grade Color)
        // Remove old grade class
        const oldGrade = target.dataset.grade;
        if (oldGrade) target.classList.remove(oldGrade);

        // Add new grade class
        // gradeStr example: "1ê¸‰", "ë“±ê¸‰ ì—†ìŒ"
        let newClass = 'text-grade-none'; // Default
        if (gradeStr && gradeStr.includes('ê¸‰')) {
            const num = gradeStr.replace(/[^0-9]/g, '');
            if (num) newClass = `text-grade-${num}`;
        } else if (gradeStr === 'ë“±ê¸‰ ì—†ìŒ') {
            newClass = 'text-grade-none';
        }

        target.classList.add(newClass);
        target.dataset.grade = newClass;

        // Update Tooltip
        target.dataset.tooltip = `${gradeStr} - ${desc}`;
    }

    // [New] Merge Visualized Text
    window.mergeVisualizedText = function (uiIsToMerge, newText, newGradeStr, newDesc) {
        if (!uiIsToMerge || uiIsToMerge.length < 2) return;

        // 1. Find all elements
        const elements = [];
        uiIsToMerge.forEach(id => {
            const el = document.querySelector(`.interactive-word[data-ui-id="${id}"]`);
            if (el) elements.push(el);
        });

        if (elements.length === 0) return;

        // 2. Keep the first one, remove others
        const firstEl = elements[0];

        // Remove others
        for (let i = 1; i < elements.length; i++) {
            elements[i].remove();
        }

        // 3. Update the first one
        firstEl.innerText = newText;

        // Update Grade Class
        const oldGrade = firstEl.dataset.grade;
        if (oldGrade) firstEl.classList.remove(oldGrade);

        // Determine new class
        let newClass = 'text-grade-none';
        if (newGradeStr && newGradeStr.includes('ê¸‰')) {
            const num = newGradeStr.replace(/[^0-9]/g, '');
            if (num) newClass = `text-grade-${num}`;
        }

        firstEl.classList.add(newClass);
        firstEl.dataset.grade = newClass;

        // Update Tooltip
        firstEl.dataset.tooltip = `${newGradeStr} - ${newDesc}`;

        // Add merge indicator? (Optional)
    }

    // [New] Render Comparison Chart (Ratio)
    function renderComparisonChart(fileStats) {
        if (!fileStats || fileStats.length === 0) return;

        // Xì¶• ì¹´í…Œê³ ë¦¬ (íŒŒì¼ëª…)
        const categories = fileStats.map(item => {
            const name = item.filename;
            return name.length > 15 ? name.substring(0, 15) + '...' : name;
        });

        // 1ê¸‰ ~ 6ê¸‰ + ë“±ê¸‰ ì—†ìŒ ì‹œë¦¬ì¦ˆ ë°ì´í„° êµ¬ì„±
        const gradeKeys = ['1ê¸‰', '2ê¸‰', '3ê¸‰', '4ê¸‰', '5ê¸‰', '6ê¸‰', 'ë“±ê¸‰ ì—†ìŒ'];
        const gradeColors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#64748b', '#94a3b8'];

        const seriesData = gradeKeys.map((key, index) => {
            return {
                name: key,
                color: gradeColors[index],
                data: fileStats.map(item => item.stats[key] || 0), // ê° íŒŒì¼ë³„ í•´ë‹¹ ê¸‰ìˆ˜ ë¹ˆë„
                visible: true // [MODIFIED] 'ë“±ê¸‰ ì—†ìŒ'ë„ ê¸°ë³¸ì ìœ¼ë¡œ í‘œì‹œ
            };
        });

        comparisonChartInstance = Highcharts.chart('fileComparisonChart', {
            chart: {
                type: 'bar', // ê°€ë¡œ ë§‰ëŒ€ ê·¸ë˜í”„
                backgroundColor: 'transparent',
                style: { fontFamily: 'var(--font-family)' }
            },
            title: { text: '' },
            xAxis: {
                categories: categories,
                title: { text: null },
                labels: {
                    style: {
                        color: 'var(--color-text)', // ë‹¤í¬ëª¨ë“œ ëŒ€ì‘
                        fontSize: '14px',
                        fontWeight: '500'
                    }
                },
                lineWidth: 0,
                tickWidth: 0
            },
            yAxis: {
                min: 0,
                max: 100, // 100% ê½‰ ì°¨ê²Œ
                title: {
                    text: 'ë¹„ìœ¨ (%)',
                    align: 'high',
                    style: { color: 'var(--color-text-muted)' }
                },
                labels: {
                    overflow: 'justify',
                    style: { color: 'var(--color-text-muted)' }
                },
                reversedStacks: false // 1ê¸‰ì´ ì™¼ìª½(ì¶• ì‹œì‘ì )ì— ì˜¤ë„ë¡ ì„¤ì •
            },
            tooltip: {
                pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.percentage:.1f}%)<br/>',
                shared: true,
                backgroundColor: 'var(--color-card-bg)',
                borderColor: 'var(--color-card-border)',
                style: { color: 'var(--color-text)' }
            },
            plotOptions: {
                bar: {
                    stacking: 'percent', // 100% ëˆ„ì  ë§‰ëŒ€
                    groupPadding: 0.02,   // ë§‰ëŒ€ ì‚¬ì´ ê°„ê²© ìµœì†Œí™”
                    pointPadding: 0.02,   // í¬ì¸íŠ¸ ê°„ ê°„ê²© ìµœì†Œí™”
                    borderWidth: 0,
                    dataLabels: {
                        enabled: true,
                        format: '{point.percentage:.0f}%',
                        filter: {
                            property: 'percentage',
                            operator: '>',
                            value: 4 // 5% ì´í•˜ ë¼ë²¨ ìˆ¨ê¹€
                        },
                        style: {
                            textOutline: 'none',
                            color: '#fff',
                            fontWeight: 'bold',
                            textShadow: '0px 0px 3px black'
                        }
                    }
                },
                series: { borderRadius: 0 }
            },
            legend: {
                reversed: false, // 1ê¸‰ë¶€í„° ìˆœì„œëŒ€ë¡œ í‘œì‹œ
                itemStyle: { color: 'var(--color-text)', fontWeight: 'bold' },
                itemHoverStyle: { color: 'var(--color-primary)' }
            },
            credits: { enabled: false },
            series: seriesData
        });
    }

    // [New] Render Absolute Bar Chart (Frequency)
    function renderAbsoluteChart(fileStats) {
        if (!fileStats || fileStats.length === 0) return;

        // Xì¶• ì¹´í…Œê³ ë¦¬ (íŒŒì¼ëª…)
        const categories = fileStats.map(item => {
            const name = item.filename;
            return name.length > 15 ? name.substring(0, 15) + '...' : name;
        });

        // 1ê¸‰ ~ 6ê¸‰ + ë“±ê¸‰ ì—†ìŒ ì‹œë¦¬ì¦ˆ ë°ì´í„° êµ¬ì„± (ë“±ê¸‰ ì—†ìŒ í¬í•¨)
        const gradeKeys = ['1ê¸‰', '2ê¸‰', '3ê¸‰', '4ê¸‰', '5ê¸‰', '6ê¸‰', 'ë“±ê¸‰ ì—†ìŒ'];
        const gradeColors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#64748b', '#94a3b8'];

        const seriesData = gradeKeys.map((key, index) => {
            return {
                name: key,
                color: gradeColors[index],
                data: fileStats.map(item => item.stats[key] || 0) // ê° íŒŒì¼ë³„ í•´ë‹¹ ê¸‰ìˆ˜ ë¹ˆë„
            };
        });

        absoluteChartInstance = Highcharts.chart('fileAbsoluteChart', {
            chart: {
                type: 'bar', // ê°€ë¡œ ë§‰ëŒ€ ê·¸ë˜í”„
                backgroundColor: 'transparent',
                style: { fontFamily: 'var(--font-family)' }
            },
            title: { text: '' },
            xAxis: {
                categories: categories,
                title: { text: null },
                labels: {
                    style: {
                        color: 'var(--color-text)', // ë‹¤í¬ëª¨ë“œ ëŒ€ì‘
                        fontSize: '14px',
                        fontWeight: '500'
                    }
                },
                lineWidth: 0,
                tickWidth: 0
            },
            yAxis: {
                min: 0,
                // ì ˆëŒ€ë¹ˆë„ì´ë¯€ë¡œ max 100 ì•„ë‹˜
                title: {
                    text: 'ë‹¨ì–´ ìˆ˜ (ê°œ)',
                    align: 'high',
                    style: { color: 'var(--color-text-muted)' }
                },
                labels: {
                    overflow: 'justify',
                    style: { color: 'var(--color-text-muted)' }
                },
                reversedStacks: false
            },
            tooltip: {
                pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}ê°œ</b><br/>',
                shared: true,
                backgroundColor: 'var(--color-card-bg)',
                borderColor: 'var(--color-card-border)',
                style: { color: 'var(--color-text)' }
            },
            plotOptions: {
                bar: {
                    stacking: 'normal', // [ì¤‘ìš”] ì ˆëŒ€ê°’ ëˆ„ì 
                    groupPadding: 0.02,
                    pointPadding: 0.02,
                    borderWidth: 0,
                    dataLabels: {
                        enabled: true,
                        format: '{point.y}', // ê°œìˆ˜ í‘œì‹œ
                        filter: {
                            property: 'y',
                            operator: '>',
                            value: 0 // 0ë³´ë‹¤ í´ ë•Œë§Œ í‘œì‹œ
                        },
                        style: {
                            textOutline: 'none',
                            color: '#fff',
                            fontWeight: 'bold',
                            textShadow: '0px 0px 3px black'
                        }
                    }
                },
                series: { borderRadius: 0 }
            },
            legend: {
                reversed: false,
                itemStyle: { color: 'var(--color-text)', fontWeight: 'bold' },
                itemHoverStyle: { color: 'var(--color-primary)' }
            },
            credits: { enabled: false },
            series: seriesData
        });
    }


    // [New] Toggle Pie Chart Mode (Integrated vs Individual)
    window.togglePieMode = function (mode) {
        const integratedArea = document.getElementById('integrated-chart-area');
        const individualArea = document.getElementById('individual-charts-container');
        const sharedLegend = document.getElementById('shared-pie-legend');

        if (mode === 'integrated') {
            integratedArea.style.display = 'block';
            individualArea.style.display = 'none';
            if (sharedLegend) sharedLegend.style.display = 'none';
        } else {
            integratedArea.style.display = 'none';
            individualArea.style.display = 'grid';
            if (sharedLegend) sharedLegend.style.display = 'flex';

            // Re-flow charts inside grid to ensure correct size
            // (Highcharts sometimes needs reflow when container becomes visible)
            Highcharts.charts.forEach(chart => {
                if (chart && chart.options.chart.type === 'pie') {
                    chart.reflow();
                }
            });
        }
    };

    // [New] Render Shared Legend
    function renderSharedLegend() {
        const container = document.getElementById('shared-pie-legend');
        if (!container) return;

        container.innerHTML = '';
        const gradeKeys = ['1ê¸‰', '2ê¸‰', '3ê¸‰', '4ê¸‰', '5ê¸‰', '6ê¸‰', 'ë“±ê¸‰ ì—†ìŒ'];
        const gradeColors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#64748b', '#94a3b8'];

        gradeKeys.forEach((key, index) => {
            const btn = document.createElement('div');
            btn.className = 'shared-legend-item';
            // Styling to mimic Highcharts legend
            btn.style.cursor = 'pointer';
            btn.style.display = 'flex';
            btn.style.alignItems = 'center';
            btn.style.gap = '6px';
            btn.style.color = 'var(--color-text)';
            btn.style.fontSize = '14px';
            btn.style.fontWeight = 'bold';
            btn.style.opacity = '1';
            btn.style.transition = 'opacity 0.2s';
            btn.dataset.seriesName = key;
            btn.onclick = () => window.toggleSharedSeries(key, btn);

            const indicator = document.createElement('span');
            indicator.style.display = 'inline-block';
            indicator.style.width = '12px';
            indicator.style.height = '12px';
            indicator.style.borderRadius = '50%';
            indicator.style.backgroundColor = gradeColors[index];

            const text = document.createElement('span');
            text.innerText = key;

            btn.appendChild(indicator);
            btn.appendChild(text);
            container.appendChild(btn);
        });
    }

    // [New] Toggle Shared Series Logic
    window.toggleSharedSeries = function (seriesName, btnElement) {
        // Toggle visual state of button
        const isHidden = btnElement.style.opacity === '0.5';
        btnElement.style.opacity = isHidden ? '1' : '0.5';
        const setVisible = isHidden; // If it was hidden, make it visible

        // Iterate all charts and toggle the specific slice
        // Note: For Pie charts in Highcharts, each slice is a 'point' in one series.
        // We need to find the point with name == seriesName.

        Highcharts.charts.forEach(chart => {
            // Check if this is one of our mini-pies (you might want a better check if there are other charts)
            // We can check container ID prefix
            if (chart && chart.renderTo.id.startsWith('mini-pie-')) {
                if (chart.series[0]) {
                    const point = chart.series[0].points.find(p => p.name === seriesName);
                    if (point) {
                        point.setVisible(setVisible);
                    }
                }
            }
        });
    }

    // [New] Render Individual Pie Charts
    function renderIndividualCharts(fileStats) {
        const container = document.getElementById('individual-charts-container');
        if (!container) return;
        container.innerHTML = ''; // Clear existing

        if (!fileStats || fileStats.length === 0) {
            container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--color-text-muted);">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        // Render Legend ONCE
        renderSharedLegend();

        const gradeColors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#64748b', '#94a3b8']; // Added No Grade color

        fileStats.forEach((item, index) => {
            const chartDiv = document.createElement('div');
            chartDiv.id = `mini-pie-${index}`;
            chartDiv.style.width = '100%';
            chartDiv.style.height = '300px'; // Reduced height since legend is gone
            chartDiv.style.backgroundColor = 'var(--color-card-bg)';
            chartDiv.style.borderRadius = '12px';
            chartDiv.style.border = '1px solid var(--muted-border-color)';
            chartDiv.style.padding = '10px';
            container.appendChild(chartDiv);

            // ë°ì´í„° ê°€ê³µ
            const chartData = [];
            // 1~6ê¸‰
            for (let i = 1; i <= 6; i++) {
                const key = `${i}ê¸‰`;
                const count = item.stats[key] || 0;
                if (count > 0) {
                    chartData.push({
                        name: key,
                        y: count,
                        color: gradeColors[i - 1],
                        gradeIndex: i
                    });
                }
            }
            // ë“±ê¸‰ ì—†ìŒ (Always check)
            const noGradeCount = item.stats['ë“±ê¸‰ ì—†ìŒ'] || 0;
            if (noGradeCount > 0) {
                chartData.push({
                    name: 'ë“±ê¸‰ ì—†ìŒ',
                    y: noGradeCount,
                    color: gradeColors[6], // #94a3b8
                    gradeIndex: 99
                });
            }

            // ì°¨íŠ¸ ë Œë”ë§
            Highcharts.chart(chartDiv.id, {
                chart: {
                    type: 'pie',
                    backgroundColor: 'transparent',
                    height: 280
                },
                title: {
                    text: item.filename,
                    style: { fontSize: '16px', fontWeight: 'bold', color: 'var(--color-text)' }
                },
                tooltip: { pointFormat: '{series.name}: <b>{point.y}ê°œ ({point.percentage:.1f}%)</b>' },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            format: '{point.name}',
                            distance: -30, // ë¼ë²¨ ì•ˆìª½ìœ¼ë¡œ
                            style: { fontSize: '12px', fontWeight: 'bold', color: '#fff', textOutline: 'none' }
                        },
                        showInLegend: false // [CHANGED] Disable per-chart legend
                    }
                },
                series: [{ name: 'ê°œìˆ˜', data: chartData }],
                credits: { enabled: false }
            });
        });
    }

    // [New] Render Overall Chart (Refactored)
    function renderOverallChart(labels, data) {
        const gradeColors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#64748b', '#94a3b8']; // Added No Grade color

        if (!labels || labels.length === 0) return;

        const chartData = [];
        labels.forEach((label, index) => {
            const count = data[index];
            if (count > 0) {
                // ë“±ê¸‰ ì—†ìŒ ì²˜ë¦¬
                if (label === 'ë“±ê¸‰ ì—†ìŒ') {
                    chartData.push({
                        name: label,
                        y: count,
                        color: gradeColors[6], // #94a3b8
                        gradeIndex: 99
                    });
                } else {
                    const gradeNum = parseInt(label.replace(/[^0-9]/g, ''));
                    // 1~6ê¸‰ë§Œ ì¶”ê°€ (í˜¹ì‹œ ëª¨ë¥¼ ì´ìƒê°’ ë°©ì§€)
                    if (gradeNum >= 1 && gradeNum <= 6) {
                        chartData.push({
                            name: label,
                            y: count,
                            color: gradeColors[gradeNum - 1],
                            gradeIndex: gradeNum
                        });
                    }
                }
            }
        });

        gradeChartInstance = Highcharts.chart('gradeChart', {
            chart: {
                type: 'pie',
                options3d: { enabled: true, alpha: 45, beta: 0 },
                backgroundColor: 'transparent',
                height: 400
            },
            title: { text: '' },
            tooltip: { pointFormat: '{series.name}: <b>{point.y}ê°œ ({point.percentage:.1f}%)</b>' },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    depth: 35,
                    dataLabels: {
                        enabled: true,
                        format: '{point.name}',
                        style: { fontSize: '20px', fontWeight: 'bold', color: 'var(--color-text)' }
                    },
                    point: {
                        events: {
                            mouseOver: function () {
                                const targetClass = this.gradeIndex === 99 ? 'text-grade-none' : `text-grade-${this.gradeIndex}`;
                                document.querySelectorAll(`.${targetClass}`).forEach(el => el.classList.add('highlight-active'));
                            },
                            mouseOut: function () {
                                document.querySelectorAll('.interactive-word').forEach(el => el.classList.remove('highlight-active'));
                            }
                        }
                    },
                    showInLegend: true // [NEW] Legend enabled
                }
            },
            legend: {
                layout: 'horizontal',
                align: 'center',
                verticalAlign: 'bottom',
                itemStyle: { color: 'var(--color-text)', fontWeight: 'bold', fontSize: '14px' },
                itemHoverStyle: { color: 'var(--color-primary)' }
            },
            series: [{ name: 'ê°œìˆ˜', data: chartData }],
            credits: { enabled: false }
        });
    }

    // [New] Text File Filter Logic
    window.filterTextFile = function (targetId) {
        // Hide all
        const contents = document.getElementsByClassName('file-text-content');
        for (let i = 0; i < contents.length; i++) {
            contents[i].style.display = 'none';
        }

        // Show target
        const target = document.getElementById(targetId);
        if (target) {
            target.style.display = 'block';
        }
    };

    document.addEventListener('DOMContentLoaded', function () {
        loadHighcharts(function () {
            // 1. ì¢…í•© ì›ê·¸ë˜í”„ ë°ì´í„° ë¡œë“œ
            try {
                const labelsEl = document.getElementById('viz-data-labels');
                const dataEl = document.getElementById('viz-data-data');
                const fileStatsEl = document.getElementById('viz-file-stats');

                if (labelsEl && labelsEl.textContent.trim()) globalInitialLabels = JSON.parse(labelsEl.textContent);
                if (dataEl && dataEl.textContent.trim()) globalInitialData = JSON.parse(dataEl.textContent);
                if (fileStatsEl && fileStatsEl.textContent.trim()) globalFileStats = JSON.parse(fileStatsEl.textContent);

            } catch (e) {
                console.error("[visualization.html] Error parsing visualization data:", e);
            }

            // [Modified] Render Overall Chart using globalFileStats to ensure 'No Grade' is included
            // (Backend passed labels might exclude it, so we recalculate from full stats)
            if (globalFileStats && globalFileStats.length > 0) {
                const aggStats = {
                    '1ê¸‰': 0, '2ê¸‰': 0, '3ê¸‰': 0, '4ê¸‰': 0, '5ê¸‰': 0, '6ê¸‰': 0,
                    'ë“±ê¸‰ ì—†ìŒ': 0
                };

                globalFileStats.forEach(file => {
                    const s = file.stats;
                    Object.keys(aggStats).forEach(k => {
                        aggStats[k] += (s[k] || 0);
                    });
                });

                const aggLabels = Object.keys(aggStats);
                const aggData = aggLabels.map(k => aggStats[k]);

                renderOverallChart(aggLabels, aggData);
            } else {
                // Fallback if no file stats (should not happen usually)
                renderOverallChart(globalInitialLabels, globalInitialData);
            }

            // 2. íŒŒì¼ë³„ ë¹„êµ ì°¨íŠ¸ (Ratio & Absolute) + [NEW] ê°œë³„ ì›ê·¸ë˜í”„
            if (globalFileStats && globalFileStats.length > 0) {
                renderComparisonChart(globalFileStats);
                renderAbsoluteChart(globalFileStats);
                renderIndividualCharts(globalFileStats); // [NEW] ì´ˆê¸° ë Œë”ë§ (Hidden ìƒíƒœ)
            } else {
                const comparisonDiv = document.getElementById('fileComparisonChart');
                const absoluteDiv = document.getElementById('fileAbsoluteChart');
                const individualContainer = document.getElementById('individual-charts-container');
                const msg = '<p style="text-align:center; color:var(--color-text-muted); padding:2rem;">ë¹„êµí•  íŒŒì¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';

                if (comparisonDiv) comparisonDiv.innerHTML = msg;
                if (absoluteDiv) absoluteDiv.innerHTML = msg;
                if (individualContainer) individualContainer.innerHTML = msg;
            }
        });
    });
</script>

<style>
    /* Tab Styling */
    .nav-tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
        background: var(--color-card-bg);
        /* ë°°ê²½ìƒ‰ ì¼ì¹˜ */
        border-radius: 99px;
        /* ë‘¥ê·¼ ìº¡ìŠ ëª¨ì–‘ */
        padding: 0.5rem;
        border: 1px solid var(--color-card-border);
        box-shadow: var(--shadow-card);
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
    }

    .nav-tab {
        border: none;
        background: transparent;
        color: var(--color-text-muted);
        padding: 0.75rem 1.5rem;
        border-radius: 99px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .nav-tab:hover {
        color: var(--color-primary);
    }

    .nav-tab.active {
        background: var(--color-primary);
        color: #fff;
        box-shadow: 0 4px 10px rgba(168, 85, 247, 0.4);
    }

    /* Existing Styles */
    .grade-badge {
        display: inline-block;
        border-radius: 12px;
        color: #fff;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* í…Œì´ë¸” ë±ƒì§€ìš© (ë°°ê²½ìƒ‰ ìˆìŒ) */
    .grade-1 {
        background-color: #10b981;
    }

    .grade-2 {
        background-color: #3b82f6;
    }

    .grade-3 {
        background-color: #8b5cf6;
    }

    .grade-4 {
        background-color: #f59e0b;
    }

    .grade-5 {
        background-color: #ef4444;
    }

    .grade-6 {
        background-color: #64748b;
    }

    /* í…ìŠ¤íŠ¸ ì‹œê°í™”ìš© */
    .text-grade-1,
    .text-grade-2,
    .text-grade-3,
    .text-grade-4,
    .text-grade-5,
    .text-grade-6 {
        text-decoration: none;
        font-weight: 500;
    }

    .text-grade-1 {
        color: #10b981;
    }

    .text-grade-2 {
        color: #3b82f6;
    }

    .text-grade-3 {
        color: #8b5cf6;
    }

    .text-grade-4 {
        color: #f59e0b;
    }

    .text-grade-5 {
        color: #ef4444;
    }

    .text-grade-6 {
        color: #64748b;
    }

    /* ê°•ì¡° íš¨ê³¼ */
    .highlight-active {
        font-weight: 900 !important;
        text-decoration: underline;
        text-decoration-thickness: 3px;
        transform: scale(1.1);
        display: inline-block;
        transition: all 0.2s ease;
    }

    /* File Content Visibility */
    .file-text-content {
        display: none;
    }

    .file-text-content.active {
        display: block;
    }

    /* [NEW] Global JS Tooltip Style */
    #global-viz-tooltip {
        position: fixed;
        background-color: var(--color-text);
        /* Theme aware */
        color: var(--background-color);
        padding: 0.5rem 0.8rem;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 600;
        white-space: nowrap;
        pointer-events: none;
        z-index: 2147483647;
        /* Highest priority */
        opacity: 0;
        transition: opacity 0.1s;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transform: translate(-50%, -100%);
        /* Center and move up closer */
    }

    #global-viz-tooltip::after {
        /* Arrow */
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -6px;
        border-width: 6px;
        border-style: solid;
        border-color: var(--color-text) transparent transparent transparent;
    }

    /* [SAFETY] Explicitly disable CSS tooltips */
    [data-tooltip]::after,
    [data-tooltip]::before {
        display: none !important;
        content: none !important;
    }
</style>

<!-- [NEW] Global Tooltip Element -->
<div id="global-viz-tooltip"></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tooltip = document.getElementById('global-viz-tooltip');
        const container = document.getElementById('highlighted-text-box');

        if (container && tooltip) {
            container.addEventListener('mouseover', function (e) {
                const target = e.target.closest('.interactive-word');
                if (target && target.dataset.tooltip) {
                    // Set content
                    tooltip.innerText = target.dataset.tooltip;

                    // Position
                    const rect = target.getBoundingClientRect();
                    tooltip.style.left = (rect.left + rect.width / 2) + 'px';
                    tooltip.style.top = (rect.top - 6) + 'px'; // 6px buffer (Closer)

                    // Show
                    tooltip.style.opacity = '1';
                }
            });

            container.addEventListener('mouseout', function (e) {
                const target = e.target.closest('.interactive-word');
                if (target) {
                    tooltip.style.opacity = '0';
                }
            });

            // Optional: Hide on scroll to prevent detachment feeling
            container.addEventListener('scroll', function () {
                tooltip.style.opacity = '0';
            }, { passive: true });
        }
    });
</script>