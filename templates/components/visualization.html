<!-- [NEW] ì‹œê°í™” ì„¹ì…˜ (ì›ê·¸ë˜í”„ + í•˜ì´ë¼ì´íŠ¸ ì›ë¬¸) -->
<hr style="margin: 3rem 0; border-color: var(--muted-border-color);">

<div class="visualization-container" style="display: flex; flex-direction: column; gap: 2rem;">

    <!-- 1. ì›ê·¸ë˜í”„ ì˜ì—­ -->
    <div>
        <h3 style="margin-bottom: 1rem; font-weight: 700;">ğŸ° ë“±ê¸‰ ë¶„í¬</h3>
        <div style="max-width: 500px; margin: 0 auto;">
            <div id="gradeChart"></div>
        </div>
    </div>

    <!-- 2. í•˜ì´ë¼ì´íŠ¸ ì›ë¬¸ ì˜ì—­ -->
    <div>
        <h3 style="margin-bottom: 1rem; font-weight: 700;">ğŸ“ ì‹œê°í™”ëœ ì›ë¬¸</h3>
        <p style="color: var(--color-text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
            * ê·¸ë˜í”„ì˜ ê° ì¡°ê°ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ í•´ë‹¹ ë“±ê¸‰ì˜ ë‹¨ì–´ê°€ ê°•ì¡°ë©ë‹ˆë‹¤.
        </p>
        <div id="highlighted-text-box"
            style="padding: 1.5rem; border-radius: 12px; line-height: 2.0; font-size: 1.2rem; border: 1px solid var(--muted-border-color);">
            {% for seg in text_segments %}
            {% if seg.type == 'graded' %}
            <span class="interactive-word {{ seg.class }}" data-grade="{{ seg.class }}"
                data-offset="{{ seg.info.offset_start }}" data-ui-id="{{ seg.info._ui_id }}"
                data-tooltip="{{ seg.info.level }} - {{ seg.info.desc }}">
                {{ seg.text }}
            </span>
            {% else %}
            <span>{{ seg.text }}</span>
            {% endif %}
            {% endfor %}
        </div>
    </div>

</div>

<!-- Data Passing (Safe Pattern) -->
<script id="viz-data-labels" type="application/json">
    {{ visualization_data.labels | tojson | default('[]') }}
</script>
<script id="viz-data-data" type="application/json">
    {{ visualization_data.data | tojson | default('[]') }}
</script>

<!-- Highcharts ë¡œë“œ í™•ì¸ ë° ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ -->
<script>
    console.log("[visualization.html] Script loaded (Safe Pattern).");

    // Highcharts ë¡œë“œ ì—¬ë¶€ ì²´í‚¹ í•¨ìˆ˜
    function loadHighcharts(callback) {
        if (window.Highcharts && window.Highcharts.chart) {
            callback();
            return;
        }
        // Highchartsê°€ ì—†ìœ¼ë©´ ë™ì  ë¡œë“œ (CDN)
        const scriptMain = document.createElement('script');
        scriptMain.src = 'https://code.highcharts.com/highcharts.js';
        scriptMain.onload = function () {
            const script3d = document.createElement('script');
            script3d.src = 'https://code.highcharts.com/highcharts-3d.js';
            script3d.onload = callback;
            document.head.appendChild(script3d);
        };
        document.head.appendChild(scriptMain);
    }

    let gradeChartInstance = null; // Chart instance storage

    // Global function to refresh chart from table data
    window.refreshGradeChart = function () {
        console.log("[refreshGradeChart] Called.");
        if (!gradeChartInstance) {
            console.warn("[refreshGradeChart] Chart instance not ready.");
            return;
        }

        // 1. Recalculate counts from the table
        const gradeCounts = { '1ê¸‰': 0, '2ê¸‰': 0, '3ê¸‰': 0, '4ê¸‰': 0, '5ê¸‰': 0, '6ê¸‰': 0 };
        const rows = document.querySelectorAll('#analysis-table tbody tr');

        let maxGrade = 0; // Track max grade for overall update

        if (rows.length === 0) return;

        rows.forEach(row => {
            const gradeBadge = row.querySelector('.grade-badge');
            if (gradeBadge) {
                const gradeText = gradeBadge.innerText.trim(); // e.g., "1ê¸‰"
                if (gradeCounts[gradeText] !== undefined) {
                    gradeCounts[gradeText]++;

                    const levelNum = parseInt(gradeText.replace('ê¸‰', ''));
                    if (levelNum > maxGrade) maxGrade = levelNum;
                }
            }
        });

        // 2. Format data for Highcharts
        const gradeColors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#64748b'];
        const chartData = [];

        Object.keys(gradeCounts).forEach((gradeKey, index) => {
            if (gradeCounts[gradeKey] > 0) {
                const gradeNum = parseInt(gradeKey.replace('ê¸‰', ''));
                chartData.push({
                    name: gradeKey,
                    y: gradeCounts[gradeKey],
                    color: gradeColors[gradeNum - 1],
                    gradeIndex: gradeNum
                });
            }
        });

        // 3. Update Chart
        gradeChartInstance.series[0].setData(chartData);

        // 4. Update Overall Grade Badge
        window.updateOverallGrade(maxGrade);
    };

    // [NEW] Global function to update overall grade badge
    window.updateOverallGrade = function (maxGrade) {
        const gradeText = maxGrade > 0 ? `${maxGrade}ê¸‰` : 'íŒë…ë¶ˆê°€';

        // Target in grade.html
        const overallText = document.getElementById('overall-grade-text');
        if (overallText) overallText.innerText = gradeText;

        // Target in generate.html
        const overallBadge = document.getElementById('overall-grade-badge');
        if (overallBadge) {
            overallBadge.className = `grade-badge grade-${maxGrade}`; // Update color class
            overallBadge.innerText = `ìµœì¢…: ${gradeText}`;
        }
    };

    // [NEW] Global function to update visualized text
    window.updateVisualizedText = function (offset, newGrade, newDesc, newForm, originalForm, uiId) {
        console.log(`[updateVisualizedText] Called with: offset=${offset}, newGrade=${newGrade}, uiId=${uiId}, newForm=${newForm}`);
        let span = null;

        // 0. [Priority] Try finding by Unique UI ID
        if (uiId) {
            span = document.querySelector(`.interactive-word[data-ui-id="${uiId}"]`);
        }

        // 1. Try finding by offset (Fallback 1)
        if (!span) {
            span = document.querySelector(`.interactive-word[data-offset="${offset}"]`);
        }

        // 2. Fallback 2: Try finding by Exact text content
        if (!span && originalForm) {
            const spans = document.querySelectorAll('.interactive-word');
            for (let s of spans) {
                if (s.innerText.trim() === originalForm.trim()) {
                    span = s;
                    break;
                }
            }
        }

        if (!span) {
            const msg = `[ì˜¤ë¥˜] ì‹œê°í™”ëœ í…ìŠ¤íŠ¸ì—ì„œ í•´ë‹¹ ë‹¨ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nUI ID: ${uiId}\nOffset: ${offset}\nOriginal: ${originalForm}`;
            console.error(msg);
            // alert(msg); // ì‚¬ìš©ì ìš”ì²­ ì‹œ ì£¼ì„ í•´ì œí•˜ì—¬ ë””ë²„ê¹… ê°€ëŠ¥í•˜ë„ë¡
            return;
        }

        // --- Apply Updates ---
        const gradeNum = newGrade.replace(/[^0-9]/g, '');
        const newClass = `text-grade-${gradeNum}`;

        // 1. Update Class (Color) - Remove old classes first
        span.classList.remove('text-grade-1', 'text-grade-2', 'text-grade-3', 'text-grade-4', 'text-grade-5', 'text-grade-6');
        span.classList.add(newClass);
        span.dataset.grade = newClass;

        // 2. Update Tooltip
        span.dataset.tooltip = `${newGrade} - ${newDesc}`;

        // 3. Update Text Content
        if (newForm && newForm.trim() !== "") {
            span.innerText = newForm;
        }

        // 4. Visual Feedback
        span.style.transition = "background-color 0.5s ease";
        span.style.backgroundColor = "#fffbeb"; // Light yellow highlight
        setTimeout(() => {
            span.style.backgroundColor = "transparent";
        }, 500);

        console.log("[updateVisualizedText] Success.");
    };


    document.addEventListener('DOMContentLoaded', function () {
        loadHighcharts(function () {
            // ì´ˆê¸° ë°ì´í„° ì„¸íŒ… (ì„œë²„ì—ì„œ ë°›ì€ê±¸ë¡œ) - JSON Script parsing pattern
            let initialLabels = [];
            let initialData = [];

            try {
                const labelsEl = document.getElementById('viz-data-labels');
                const dataEl = document.getElementById('viz-data-data');

                if (labelsEl && labelsEl.textContent.trim()) {
                    initialLabels = JSON.parse(labelsEl.textContent);
                }
                if (dataEl && dataEl.textContent.trim()) {
                    initialData = JSON.parse(dataEl.textContent);
                }
            } catch (e) {
                console.error("[visualization.html] Error parsing visualization data:", e);
                // Fail gracefully
            }

            const gradeColors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#64748b'];

            if (!initialLabels || initialLabels.length === 0) {
                const chartDiv = document.getElementById('gradeChart');
                if (chartDiv) chartDiv.innerHTML = '<p style="text-align:center; color:#999;">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const chartData = initialLabels.map((label, index) => {
                const gradeNum = parseInt(label.replace(/[^0-9]/g, ''));
                return {
                    name: label,
                    y: initialData[index],
                    color: gradeColors[gradeNum - 1],
                    gradeIndex: gradeNum
                };
            });

            gradeChartInstance = Highcharts.chart('gradeChart', {
                chart: {
                    type: 'pie',
                    options3d: { enabled: true, alpha: 45, beta: 0 },
                    backgroundColor: 'transparent',
                    height: 400
                },
                title: { text: '' },
                tooltip: { pointFormat: '{series.name}: <b>{point.y}ê°œ ({point.percentage:.1f}%)</b>' },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        depth: 35,
                        dataLabels: {
                            enabled: true,
                            format: '{point.name}',
                            style: { fontSize: '20px', fontWeight: 'bold', color: 'var(--color-text)' }
                        },
                        point: {
                            events: {
                                mouseOver: function () {
                                    const targetClass = `text-grade-${this.gradeIndex}`;
                                    document.querySelectorAll(`.${targetClass}`).forEach(el => el.classList.add('highlight-active'));
                                },
                                mouseOut: function () {
                                    document.querySelectorAll('.interactive-word').forEach(el => el.classList.remove('highlight-active'));
                                }
                            }
                        }
                    }
                },
                series: [{ name: 'ê°œìˆ˜', data: chartData }],
                credits: { enabled: false }
            });
        });
    });
</script>

<style>
    .grade-badge {
        display: inline-block;
        border-radius: 12px;
        color: #fff;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* í…Œì´ë¸” ë±ƒì§€ìš© (ë°°ê²½ìƒ‰ ìˆìŒ) */
    .grade-1 {
        background-color: #10b981;
    }

    .grade-2 {
        background-color: #3b82f6;
    }

    .grade-3 {
        background-color: #8b5cf6;
    }

    .grade-4 {
        background-color: #f59e0b;
    }

    .grade-5 {
        background-color: #ef4444;
    }

    .grade-6 {
        background-color: #64748b;
    }

    /* í…ìŠ¤íŠ¸ ì‹œê°í™”ìš© (ë°°ê²½ìƒ‰ ì—†ìŒ, ê¸€ììƒ‰ë§Œ, ê¸°ë³¸ ë°‘ì¤„ ì—†ìŒ) */
    .text-grade-1,
    .text-grade-2,
    .text-grade-3,
    .text-grade-4,
    .text-grade-5,
    .text-grade-6 {
        text-decoration: none;
        font-weight: 500;
    }

    .text-grade-1 {
        color: #10b981;
    }

    .text-grade-2 {
        color: #3b82f6;
    }

    .text-grade-3 {
        color: #8b5cf6;
    }

    .text-grade-4 {
        color: #f59e0b;
    }

    .text-grade-5 {
        color: #ef4444;
    }

    .text-grade-6 {
        color: #64748b;
    }

    /* ê°•ì¡° íš¨ê³¼ (Bold + Underline) */
    .highlight-active {
        font-weight: 900 !important;
        text-decoration: underline;
        text-decoration-thickness: 3px;
        transform: scale(1.1);
        /* ì‚´ì§ ì»¤ì§€ëŠ” íš¨ê³¼ ì¶”ê°€ */
        display: inline-block;
        /* transform ì ìš© ìœ„í•´ */
        transition: all 0.2s ease;
    }
</style>