{% extends 'base.html' %}
{% block content %}
<section>
  <h2>âœ¨ ìœ í˜•ë³„ ë¬¸ì œ ìƒì„±ê¸°</h2>
  <p>ì›í•˜ëŠ” ìœ í˜•ì„ ì„ íƒí•˜ê³  ì¡°ê±´ì„ ì…ë ¥í•˜ë©´ AIê°€ ë¬¸ì œë¥¼ ë§Œë“­ë‹ˆë‹¤.</p>

  <form onsubmit="return false;" class="form mt-4">

    <fieldset>
      <legend>1. ê¸°ë³¸ ì„¤ì •</legend>

      <label>ë¬¸ì œ ìœ í˜•</label>
      <div class="grid mb-4" style="grid-template-columns: 1fr 1fr;">
        <label class="radio-card">
          <input type="radio" name="quiz_type" value="binary" checked onchange="toggleInputSection()">
          <span class="radio-title">âš–ï¸ ë‘˜ ì¤‘ í•˜ë‚˜ ê³ ë¥´ê¸°</span>
          <span class="radio-desc">ì´ê²ƒ / ê·¸ê²ƒ (ë¬¸ë§¥ íŒŒì•…)</span>
        </label>

        <label class="radio-card">
          <input type="radio" name="quiz_type" value="matching" onchange="toggleInputSection()">
          <span class="radio-title">ğŸ”— ë‹¨ì–´ì™€ ëœ» ì§ì§“ê¸°</span>
          <span class="radio-desc">ì„  ì‡ê¸° ê²Œì„ (ì–´íœ˜ í•™ìŠµ)</span>
        </label>
      </div>

      <label>ëª©í‘œ ë“±ê¸‰</label>
      <div class="grade-grid mb-2">
        <label><input type="checkbox" name="grades" value="1" checked> 1ê¸‰</label>
        <label><input type="checkbox" name="grades" value="2"> 2ê¸‰</label>
        <label><input type="checkbox" name="grades" value="3"> 3ê¸‰</label>
        <label><input type="checkbox" name="grades" value="4"> 4ê¸‰</label>
        <label><input type="checkbox" name="grades" value="5"> 5ê¸‰</label>
        <label><input type="checkbox" name="grades" value="6"> 6ê¸‰</label>
      </div>
    </fieldset>

    <fieldset id="section-common-target" style="overflow: visible; z-index: 10;">
      <legend>2. ì¶œì œ ëŒ€ìƒ ì„ íƒ (ë‹¨ì–´/ë¬¸ë²•)</legend>
      <div class="mode-toggle">
        <input type="radio" class="btn-check" name="input_mode" id="mode-search" value="search" checked
          onchange="toggleMode()">
        <label class="mode-btn" for="mode-search">ğŸ” ê²€ìƒ‰</label>

        <input type="radio" class="btn-check" name="input_mode" id="mode-sentence" value="sentence"
          onchange="toggleMode()">
        <label class="mode-btn" for="mode-sentence">ğŸ“ ë¬¸ì¥ ë¶„ì„</label>
      </div>

      <div id="section-search" class="mt-4">
        {% include 'components/search_bar.html' %}
      </div>

      <div id="section-sentence" class="mt-4" style="display: none;">
        <div class="input-group">
          <textarea id="sentence-input" rows="2" placeholder="ì˜ˆ: ë‚˜ëŠ” í•œêµ­ ìŒì‹ì´ ì¢‹ì•„ìš”"></textarea>
          <button type="button" class="secondary" onclick="analyzeSentence()"
            style="width: auto; margin-bottom: 0;">ë¶„ì„</button>
        </div>
        <div id="morpheme-area" class="morpheme-container mt-3" style="display: none;">
          <div id="morpheme-chips" class="chip-wrapper"></div>
        </div>
      </div>

      <div class="selected-target-display mt-4">
        <span>ì„ íƒë¨:</span>
        <strong id="display-target" class="gradient-text">ì—†ìŒ</strong>
        <input type="hidden" id="final-target-value">
        <input type="hidden" id="final-context-value">
      </div>
    </fieldset>

    <fieldset id="section-matching-target" style="display: none;">
      <legend>2. ì§ì§“ê¸° ë‹¨ì–´ ì…ë ¥</legend>
      <p class="small-desc" style="color:#aaa; margin-bottom:15px;">
        ğŸ’¡ ë‹¨ì–´ë¥¼ 1ê°œë§Œ ì…ë ¥í•´ë„ ë‚˜ë¨¸ì§€ëŠ” AIê°€ ë¹„ìŠ·í•œ ì£¼ì œë¡œ ì±„ì›Œì¤ë‹ˆë‹¤! (ìµœëŒ€ 3ê°œ)
      </p>
      <div class="input-group mb-2">
        <input type="text" class="matching-word-input" placeholder="ë‹¨ì–´ 1 (ì˜ˆ: ì‚¬ê³¼)">
      </div>
      <div class="input-group mb-2">
        <input type="text" class="matching-word-input" placeholder="ë‹¨ì–´ 2 (ì„ íƒ)">
      </div>
      <div class="input-group mb-2">
        <input type="text" class="matching-word-input" placeholder="ë‹¨ì–´ 3 (ì„ íƒ)">
      </div>
    </fieldset>

    <fieldset class="mt-4">
      <legend>3. ì¶”ê°€ ìš”ì²­ (ì„ íƒ)</legend>
      <div class="input-group">
        <textarea id="user-prompt" rows="2" placeholder="ì˜ˆ: ì•„ì£¼ ì‰½ê²Œ ì„¤ëª…í•´ì¤˜, ì˜ˆë¬¸ì„ í¬í•¨í•´ì¤˜..."></textarea>
      </div>
    </fieldset>

    <button type="button" class="primary-gradient-button" onclick="generateQuiz()" style="margin-top: 20px;">
      âœ¨ ë¬¸ì œ ìƒì„±í•˜ê¸°
    </button>
  </form>

  <div id="quiz-result-area" style="display: none; margin-top: 40px;">
  </div>
</section>

<style>
  /* ì§ì§“ê¸° ê²Œì„ìš© ìŠ¤íƒ€ì¼ */
  .matching-game-container {
    position: relative;
    width: 100%;
    min-height: 400px;
    display: flex;
    justify-content: space-between;
    padding: 20px;
    background: #1a1a2e;
    border-radius: 12px;
    border: 1px solid #444;
    user-select: none;
  }

  .svg-layer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10;
  }

  .column {
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    width: 40%;
    z-index: 20;
  }

  .item-card {
    background: #2a2a3e;
    border: 2px solid #555;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    color: white;
    text-align: center;
    cursor: pointer;
    position: relative;
    transition: 0.2s;
  }

  .item-card:hover {
    border-color: #3b82f6;
    background: #333;
  }

  .item-card.connected {
    border-color: #22c55e;
    background: rgba(34, 197, 94, 0.1);
  }

  .dot {
    width: 10px;
    height: 10px;
    background: #888;
    border-radius: 50%;
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
  }

  .left .dot {
    right: -6px;
  }

  .right .dot {
    left: -6px;
  }

  /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ë“¤ */
  .grade-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .grade-grid label {
    display: flex;
    align-items: center;
    background: rgba(255, 255, 255, 0.05);
    padding: 8px 16px;
    border-radius: 20px;
    border: 1px solid #444;
    cursor: pointer;
  }

  .grade-grid input {
    margin-right: 8px;
  }

  .radio-card {
    display: flex;
    flex-direction: column;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid #444;
    padding: 1rem;
    border-radius: 12px;
    cursor: pointer;
    transition: 0.2s;
  }

  .radio-card input:checked+.radio-title {
    color: #a855f7;
  }

  .mode-toggle {
    display: flex;
    gap: 10px;
    background: #111;
    padding: 5px;
    border-radius: 50px;
    margin-bottom: 1rem;
  }

  .mode-btn {
    flex: 1;
    text-align: center;
    padding: 10px;
    border-radius: 50px;
    cursor: pointer;
    border: 1px solid #333;
    color: #888;
  }

  .btn-check:checked+.mode-btn {
    background: var(--brand-gradient);
    color: white;
    font-weight: bold;
  }

  .morph-chip {
    background: #333;
    color: #ccc;
    border: 1px solid #555;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    margin: 4px;
    display: inline-block;
  }

  .morph-chip.selected {
    background: var(--brand-gradient);
    color: white;
  }

  .quiz-opt-btn {
    width: 100%;
    padding: 15px;
    margin-bottom: 10px;
    border: 2px solid #555;
    background: transparent;
    color: white;
    border-radius: 12px;
    text-align: left;
    cursor: pointer;
  }

  .quiz-opt-btn.correct {
    background: #10b981;
    border-color: #10b981;
  }

  .quiz-opt-btn.wrong {
    background: #ef4444;
    border-color: #ef4444;
  }
</style>

<script src="{{ url_for('static', filename='js/matching_quiz.js') }}"></script>
<script src="{{ url_for('static', filename='search.js') }}"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    toggleInputSection();
  });

  function toggleInputSection() {
    const quizType = document.querySelector('input[name="quiz_type"]:checked').value;
    const commonSection = document.getElementById('section-common-target');
    const matchingSection = document.getElementById('section-matching-target');

    if (quizType === 'matching') {
      commonSection.style.display = 'none';
      matchingSection.style.display = 'block';
    } else {
      commonSection.style.display = 'block';
      matchingSection.style.display = 'none';
    }

    document.getElementById('quiz-result-area').style.display = 'none';
  }

  function toggleMode() {
    const isSearch = document.getElementById('mode-search').checked;
    document.getElementById('section-search').style.display = isSearch ? 'block' : 'none';
    document.getElementById('section-sentence').style.display = isSearch ? 'none' : 'block';
    resetSelection();
  }

  function resetSelection() {
    document.getElementById('final-target-value').value = '';
    document.getElementById('display-target').innerText = 'ì—†ìŒ';
    document.getElementById('morpheme-area').style.display = 'none';
  }

  function selectTarget(display, val, context) {
    document.getElementById('final-target-value').value = val;
    document.getElementById('final-context-value').value = context || '';
    document.getElementById('display-target').innerText = display;
  }

  initSearchModule(function (item) {
    const display = `${item.text} [${item.pos}]`;
    const val = `${item.text} (${item.pos})`;
    selectTarget(display, val, item.desc);
    document.getElementById('common-search-results').style.display = 'none';
    document.getElementById('common-search-input').value = '';
  });

  async function analyzeSentence() {
    const text = document.getElementById('sentence-input').value;
    if (!text) return alert("ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”.");
    const res = await fetch('/analyze_sentence_for_quiz', {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sentence: text })
    });
    const data = await res.json();
    const box = document.getElementById('morpheme-chips');
    box.innerHTML = '';
    document.getElementById('morpheme-area').style.display = 'block';
    data.morphs.forEach(m => {
      const chip = document.createElement('div');
      chip.className = 'morph-chip';
      chip.innerText = m.form;
      chip.onclick = function () {
        selectTarget(`${m.form} [${m.tag}]`, `${m.form} (${m.tag})`, text);
      }
      box.appendChild(chip);
    });
  }

  async function generateQuiz() {
    const quizType = document.querySelector('input[name="quiz_type"]:checked').value;
    const btn = document.querySelector('button[onclick="generateQuiz()"]');

    btn.textContent = "ğŸ¤– ìƒì„± ì¤‘...";
    btn.disabled = true;

    try {
      if (quizType === 'matching') {
        const inputs = document.querySelectorAll('.matching-word-input');
        const words = Array.from(inputs).map(input => input.value.trim()).filter(val => val !== '');

        if (words.length === 0) {
          alert("ìµœì†Œ 1ê°œì˜ ë‹¨ì–´ëŠ” ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
          btn.textContent = "âœ¨ ë¬¸ì œ ìƒì„±í•˜ê¸°";
          btn.disabled = false;
          return;
        }

        const res = await fetch('/api/generate-matching', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ words: words })
        });
        const result = await res.json();

        if (result.status === 'success') {
          renderMatchingGame(result.data);
        } else {
          alert("ì˜¤ë¥˜: " + result.message);
        }

      } else {
        const target = document.getElementById('final-target-value').value;
        const grades = Array.from(document.querySelectorAll('input[name="grades"]:checked')).map(cb => cb.value);
        const userPrompt = document.getElementById('user-prompt').value;
        const context = document.getElementById('final-context-value').value;

        if (!target) { alert("ì¶œì œ ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”."); throw new Error("No Target"); }

        // â¬‡ï¸ ì´ ë¶€ë¶„ì„ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•©ë‹ˆë‹¤. (ë³€ìˆ˜ ì´ë¦„ ì˜¤íƒ€ ìˆ˜ì •)
        const res = await fetch('/generate_quiz_action', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            target,
            grades, // â¬…ï¸ 'grades' ë³€ìˆ˜ë¥¼ ì •í™•íˆ ì‚¬ìš©
            quiz_type: quizType,
            context,
            user_prompt: userPrompt // â¬…ï¸ 'userPrompt' ë³€ìˆ˜ë¥¼ ì •í™•íˆ ì‚¬ìš©
          })
        });
        data = await res.json();

        if (data.error) alert(data.error);
        else renderTextQuiz(data);
      }
    } catch (e) {
      if (e.message !== "No Target") {
        console.error(e);
        alert("ìƒì„± ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    } finally {
      btn.textContent = "âœ¨ ë¬¸ì œ ìƒì„±í•˜ê¸°";
      btn.disabled = false;
    }
  }

  function renderTextQuiz(data) {
    const area = document.getElementById('quiz-result-area');
    area.style.display = 'block';

    area.innerHTML = `
      <article class="result quiz-card">
        <div class="quiz-header">
           <span class="badge">ìƒì„±ë¨</span>
           <h3>${data.question_text}</h3>
        </div>
        <div id="quiz-options-container" class="mt-3"></div>
        <div id="text-feedback" class="mt-3" style="display:none; padding:10px; background:rgba(255,255,255,0.05); border-radius:8px;">
            <strong>ğŸ’¡ ì •ë‹µ ë° í•´ì„¤:</strong> <span id="expl-text"></span>
        </div>
      </article>
    `;

    const container = document.getElementById('quiz-options-container');
    data.options.forEach((opt, idx) => {
      const btn = document.createElement('button');
      btn.className = 'quiz-opt-btn';
      btn.innerText = `${idx + 1}. ${opt}`;
      btn.onclick = () => {
        const btns = document.querySelectorAll('.quiz-opt-btn');
        btns.forEach(b => b.disabled = true);
        if (idx === data.answer_index) btn.classList.add('correct');
        else {
          btn.classList.add('wrong');
          btns[data.answer_index].classList.add('correct');
        }
        document.getElementById('expl-text').innerText = data.explanation;
        document.getElementById('text-feedback').style.display = 'block';
      };
      container.appendChild(btn);
    });
  }

  function renderMatchingGame(data) {
    const area = document.getElementById('quiz-result-area');
    area.style.display = 'block';

    area.innerHTML = `
        <article class="result quiz-card">
            <div class="quiz-header">
                <span class="badge" style="background:#3b82f6;">ì§ì§“ê¸°</span>
                <h3>ë‹¨ì–´ì™€ ëœ»ì„ ì˜¬ë°”ë¥´ê²Œ ì—°ê²°í•˜ì„¸ìš”.</h3>
            </div>
            <div id="matching-game-wrapper" class="mt-4"></div>
        </article>
    `;

    initMatchingGame('matching-game-wrapper', data);
  }
</script>
{% endblock %}