{% extends 'base.html' %}
{% block content %}
<section>
  <h2>ğŸ”® ìƒì„±</h2>
  <p>ì„¤ì •í•˜ì‹  ë“±ê¸‰ì— ë§ì§€ ì•ŠëŠ” ë‹¨ì–´ê°€ ë‚˜ì˜¤ë©´, AIê°€ ìŠ¤ìŠ¤ë¡œ ìˆ˜ì •í•˜ì—¬ ë‹¤ì‹œ ì‘ì„±í•©ë‹ˆë‹¤.</p>

  <form method="post" class="form" id="generate-form">

    <fieldset>
      <legend>1. ì›í•˜ëŠ” ë“±ê¸‰ ì„ íƒ</legend>
      <div class="grade-grid">
        <label
          style="border-color: var(--primary-color); background: rgba(var(--primary-rgb), 0.1); margin-right: 15px;">
          <input type="checkbox" id="check-all"> ëª¨ë‘
        </label>
        <label><input type="checkbox" name="grades" value="1" class="grade-cb"> 1ê¸‰</label>
        <label><input type="checkbox" name="grades" value="2" class="grade-cb"> 2ê¸‰</label>
        <label><input type="checkbox" name="grades" value="3" class="grade-cb"> 3ê¸‰</label>
        <label><input type="checkbox" name="grades" value="4" class="grade-cb"> 4ê¸‰</label>
        <label><input type="checkbox" name="grades" value="5" class="grade-cb"> 5ê¸‰</label>
        <label><input type="checkbox" name="grades" value="6" class="grade-cb"> 6ê¸‰</label>
      </div>
    </fieldset>

    <fieldset style="position: relative; overflow: visible; z-index: 1000;">
      <legend>2. í¬í•¨í•  ë‹¨ì–´/ë¬¸ë²•</legend>
      {% include 'components/search_bar.html' %}
      <div id="selected-tags-container" class="tags-area"></div>
      <input type="hidden" name="keyword" id="final-keyword-payload">
      <input type="hidden" name="hint" id="final-hint-payload">
    </fieldset>

    <button type="submit" class="primary-gradient-button" id="generate-submit-btn" style="margin-top: 20px;">
      âœ¨ ë¬¸ì¥ ìƒì„±í•˜ê¸° (ìë™ ê²€ì¦)
    </button>
  </form>

  <!-- [NEW] ìƒì„± ì‹¤íŒ¨ ë©”ì‹œì§€ -->
  {% if not generated_sentence and rejected_history %}
  <div class="result-card failure"
    style="margin: 2rem auto; width: fit-content; min-width: 300px; max-width: 95%; padding: 25px; border: 1px solid #ff6b6b; border-radius: 12px; background: rgba(255,107,107,0.1);">
    <h3 style="color: #ff6b6b; margin-top: 0;">ğŸ˜¢ ë¬¸ì¥ ìƒì„± ì‹¤íŒ¨</h3>
    <p>ìš”ì²­í•˜ì‹  ë“±ê¸‰ ì¡°ê±´ì— ì—„ê²©í•˜ê²Œ ë§ëŠ” ë¬¸ì¥ì„ 5ë²ˆ ì‹œë„í–ˆìœ¼ë‚˜ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>
    <p style="font-size: 0.9em; color: #ccc;">(ìš”ì²­í•˜ì‹  ë‹¨ì–´ê°€ ë„ˆë¬´ ì–´ë µê±°ë‚˜ ì¡°ê±´ì´ ê¹Œë‹¤ë¡œìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)</p>
  </div>
  {% endif %}

  {% if generated_sentence %}
  <article class="result-card"
    style="margin: 2rem auto; width: fit-content; min-width: 300px; max-width: 95%; padding: 25px; border: 1px solid var(--muted-border-color); border-radius: 12px; background: rgba(255,255,255,0.02);">

    <header
      style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 15px; border-bottom: 1px solid #444; gap: 20px;">
      <h3 style="margin: 0; font-size: 1.2rem; white-space: nowrap;">ğŸ“ ìµœì¢… ê²°ê³¼</h3>
      {% if final_grade %}
      <span id="overall-grade-badge" class="grade-badge grade-{{ final_grade|replace('ê¸‰','') }}"
        style="font-size: 1rem; padding: 6px 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); white-space: nowrap;">
        ìµœì¢…: {{ final_grade }}
      </span>
      {% endif %}
    </header>

    <div style="display: flex; align-items: center; justify-content: space-between; gap: 20px; margin-bottom: 10px;">
      <p id="generated-sentence-text"
        style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color); margin: 0; line-height: 1.4; word-break: keep-all;">
        {{ generated_sentence }}
      </p>
      <button type="button" class="secondary outline" style="width: auto; margin: 0; white-space: nowrap;"
        onclick="navigator.clipboard.writeText(document.getElementById('generated-sentence-text').innerText).then(()=>alert('ë³µì‚¬ì™„ë£Œ!'))">
        ğŸ“‹ ë³µì‚¬
      </button>
    </div>

    <!-- [NEW] Sidebar -->
    {% include 'components/sidebar.html' %}

    <!-- 1. Frequency Table -->
    {% if file_stats_list %}
    {% include 'components/frequency_table.html' %}
    {% endif %}

    <!-- 2. Charts & Visualization -->
    {% if visualization_data %}
    <div id="section-charts" style="margin-top: 2rem;">
      {% include 'components/visualization.html' %}
    </div>
    {% endif %}

    <!-- 3. Detailed Analysis Table -->
    {% if analysis_result %}
    <div id="section-analysis" style="margin-top: 2rem;">
      <h4 style="font-weight: 700;">ğŸ“‹ ìƒì„¸ ë¶„ì„ ê²°ê³¼</h4>
      {% include 'components/analysis_table.html' %}
    </div>
    {% endif %}


    {% if rejected_history %}
    <div style="margin-top: 20px; border-top: 1px dashed #555; padding-top: 15px;">
      <h4 style="font-size: 0.95rem; color: #ff6b6b; margin-bottom: 10px;">ğŸš« ê²€ì¦ ê³¼ì •ì—ì„œ ìˆ˜ì •ëœ ë¬¸ì¥ë“¤</h4>
      <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.9rem; color: #aaa;">
        {% for item in rejected_history %}
        <li style="margin-bottom: 8px; padding: 8px; background: rgba(255,0,0,0.05); border-radius: 6px;">
          <div style="text-decoration: line-through; margin-bottom: 4px;">{{ item.sentence }}</div>
          <div style="font-size: 0.8em; color: #ff6b6b;">ğŸ‘‰ ì‚¬ìœ : {{ item.reason }}</div>
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

  </article>
  {% endif %}

</section>

<script src="{{ url_for('static', filename='search.js') }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const tagsContainer = document.getElementById('selected-tags-container');
    const finalKeywordPayload = document.getElementById('final-keyword-payload');
    const finalHintPayload = document.getElementById('final-hint-payload');
    let selectedData = [];

    const form = document.getElementById('generate-form');
    const submitBtn = document.getElementById('generate-submit-btn');
    if (form && submitBtn) {
      form.addEventListener('submit', function () {
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'AIê°€ ë¬¸ì¥ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤... <span class="loading-spinner"></span>';
        submitBtn.style.opacity = '0.8';
      });
    }

    function updateHiddenInput() {
      finalKeywordPayload.value = selectedData.map(item => item.text).join(', ');
      finalHintPayload.value = selectedData.map(item => item.hint).join(', ');
    }

    function addTag(text, grade, hint) {
      if (selectedData.some(item => item.text === text)) return;
      const cleanHint = (hint && hint !== 'nan') ? hint : '';
      selectedData.push({ text: text, grade: grade, hint: cleanHint });
      updateHiddenInput();

      const tag = document.createElement('span');
      tag.className = 'keyword-tag';
      tag.innerHTML = `<span class="tag-text">${text}</span><span class="tag-grade">${grade}</span><button type="button" class="tag-remove">Ã—</button>`;
      tag.querySelector('.tag-remove').addEventListener('click', () => {
        selectedData = selectedData.filter(item => item.text !== text);
        updateHiddenInput();
        tag.remove();
      });
      tagsContainer.appendChild(tag);
    }

    // [Reference] Table util functions copied/adapted for Generate page
    window.copyTableText = function (tableId) {
      const table = document.getElementById(tableId);
      if (!table) return;
      let textToCopy = "";
      const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText.trim());
      textToCopy += headers.join('\t') + '\n';
      const rows = table.querySelectorAll('tbody tr');
      rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll('td')).map(td => td.innerText.replace(/[\r\n]+/g, " ").trim());
        textToCopy += cells.join('\t') + '\n';
      });
      navigator.clipboard.writeText(textToCopy).then(() => alert('ë³µì‚¬ì™„ë£Œ!')).catch(err => alert('ì‹¤íŒ¨'));
    };

    window.downloadTableAsCsv = function (tableId, filename) {
      const table = document.getElementById(tableId);
      if (!table) return;
      let csvContent = "\uFEFF";
      const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText.trim());
      csvContent += headers.join(',') + '\n';
      const rows = table.querySelectorAll('tbody tr');
      rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll('td')).map(td => {
          let text = td.innerText.replace(/[\r\n]+/g, " ").trim();
          if (text.includes(',')) text = `"${text}"`;
          return text;
        });
        csvContent += cells.join(',') + '\n';
      });
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', filename || 'data.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };


    initSearchModule(function (item) {
      addTag(item.text, item.grade, item.desc);
      document.getElementById('common-search-input').value = '';
      document.getElementById('common-search-results').style.display = 'none';
    });

    // [NEW] 'ëª¨ë‘' ì²´í¬ë°•ìŠ¤ ë¡œì§
    const checkAll = document.getElementById('check-all');
    const gradeCbs = document.querySelectorAll('.grade-cb');

    if (checkAll) {
      checkAll.addEventListener('change', function () {
        const isChecked = this.checked;
        gradeCbs.forEach(cb => cb.checked = isChecked);
      });

      gradeCbs.forEach(cb => {
        cb.addEventListener('change', function () {
          if (!this.checked) checkAll.checked = false;
          else {
            const allChecked = Array.from(gradeCbs).every(c => c.checked);
            checkAll.checked = allChecked;
          }
        });
      });
    }
  });
</script>

<style>
  /* [ê²€ìƒ‰ì°½ ê³ ì • ìŠ¤íƒ€ì¼] */
  .search-wrapper {
    position: relative !important;
    overflow: visible !important;
    margin-bottom: 10px;
  }

  #common-search-results {
    position: absolute !important;
    top: 100% !important;
    left: 0 !important;
    right: 0 !important;
    z-index: 9999 !important;
    z-index: 9999 !important;
    background: var(--background-color);
    border: 1px solid var(--muted-border-color);
    border-radius: 0 0 8px 8px;
    max-height: 250px;
    overflow-y: auto;
    display: none;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
  }

  .search-result-item {
    padding: 12px;
    padding: 12px;
    border-bottom: 1px solid var(--muted-border-color);
    cursor: pointer;
    transition: background 0.1s;
    text-align: left;
  }

  .search-result-item:hover {
    background-color: var(--secondary-bg);
  }

  /* [íƒœê·¸ ìŠ¤íƒ€ì¼ - ìŠ¬ë¦¼ ë²„ì „] */
  .tags-area {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
    min-height: 30px;
  }

  .keyword-tag {
    display: inline-flex;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.85rem;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    animation: fadeIn 0.2s ease-out;
  }

  .tag-grade {
    font-size: 0.75em;
    background: rgba(0, 0, 0, 0.2);
    padding: 1px 5px;
    border-radius: 4px;
    margin: 0 6px;
  }

  .tag-remove {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    font-size: 1rem;
    cursor: pointer;
    padding: 0;
    line-height: 1;
    display: flex;
    align-items: center;
    margin-left: 2px;
  }

  .tag-remove:hover {
    color: #fff;
  }

  /* [ê¸°íƒ€ ìŠ¤íƒ€ì¼] */
  .toggle-switch {
    position: relative;
    width: 46px;
    height: 24px;
    display: inline-block;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #555;
    transition: .4s;
    border-radius: 34px;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }

  input:checked+.slider {
    background-color: var(--primary-color);
  }

  input:checked+.slider:before {
    transform: translateX(22px);
  }

  .grade-grid {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .grade-grid label {
    background: rgba(255, 255, 255, 0.05);
    padding: 8px 12px;
    border-radius: 20px;
    cursor: pointer;
  }
</style>
{% endblock %}