{% extends 'base.html' %}
{% block content %}
<section>
  <h2>ğŸš€ ë¶„ì„</h2>
  <p>ë¬¸ì¥ì„ ì…ë ¥í•˜ê³  ì œì¶œí•˜ë©´ ë“±ê¸‰ê³¼ ìƒì„¸ ë¶„ì„ í‘œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

  <form method="post" class="form" id="grade-form">
    <label for="sentence">ë¬¸ì¥</label>
    <textarea id="sentence" name="sentence" rows="3"
      placeholder="ì˜ˆ) ì‚¬ê³¼ê°€ ë§›ì—†ìœ¼ë©´ ì‚¬ê³¼í• ê²Œìš”">{{ last_sentence or '' }}</textarea>

    <div class="toggle-container">
      <label class="toggle-switch">
        <input type="checkbox" id="clear-toggle">
        <span class="slider">
          <span class="slider-text" data-on="ON" data-off="OFF"></span>
        </span>
      </label>
      <label for="clear-toggle" class="toggle-label">ë¬¸ì¥ íŒë… í›„ ì§€ì›Œì§‘ë‹ˆë‹¤.</label>
      <input type="hidden" id="clear-toggle-input" name="clear_on_submit" value="false">
    </div>

    <button type="submit">íŒë…í•˜ê¸°</button>
  </form>

  <details style="margin-top: 1rem; margin-bottom: 2rem;">
    <summary style="font-weight: bold; cursor: pointer;">ğŸ“‚ íŒŒì¼ ì—…ë¡œë“œ (.txt)</summary>
    <div style="padding: 1rem; border: 1px solid var(--muted-border-color); border-radius: 8px; margin-top: 0.5rem;">
      <form action="{{ url_for('main.grade_upload') }}" method="post" enctype="multipart/form-data" class="grid"
        style="grid-template-columns: 3fr 1fr; gap: 10px; margin-bottom:0; padding:0; border:none; box-shadow:none; background:transparent; backdrop-filter:none; -webkit-backdrop-filter:none;">
        <input type="file" name="file" accept=".txt" required>
        <button type="submit" class="secondary">ì—…ë¡œë“œ ë° íŒë…</button>
      </form>
      <small style="color: var(--color-text-muted);">â€» í˜„ì¬ <strong>.txt</strong> íŒŒì¼ë§Œ ì§€ì›í•©ë‹ˆë‹¤.</small>
    </div>
  </details>

  <hr style="margin: 2rem 0; border-color: var(--muted-border-color);">

  {% if grade_stats %}
  <article class="result-card">
    <header>
      <strong style="font-size: 1.3rem;">íŒë… ê²°ê³¼</strong>
    </header>

    <!-- [NEW] ë“±ê¸‰ ë¹ˆë„ìˆ˜ í…Œì´ë¸” -->
    <div style="margin: 1.5rem 0; overflow-x: auto; text-align: center;">
      <table role="grid" style="text-align: center; width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="border-bottom: 1px solid var(--muted-border-color);">
            <th style="padding: 10px;"><span
                style="display:inline-block; border-radius:12px; background-color:#10b981; color:#fff; padding:4px 12px; white-space:nowrap;">1ê¸‰</span>
            </th>
            <th style="padding: 10px;"><span
                style="display:inline-block; border-radius:12px; background-color:#3b82f6; color:#fff; padding:4px 12px; white-space:nowrap;">2ê¸‰</span>
            </th>
            <th style="padding: 10px;"><span
                style="display:inline-block; border-radius:12px; background-color:#8b5cf6; color:#fff; padding:4px 12px; white-space:nowrap;">3ê¸‰</span>
            </th>
            <th style="padding: 10px;"><span
                style="display:inline-block; border-radius:12px; background-color:#f59e0b; color:#fff; padding:4px 12px; white-space:nowrap;">4ê¸‰</span>
            </th>
            <th style="padding: 10px;"><span
                style="display:inline-block; border-radius:12px; background-color:#ef4444; color:#fff; padding:4px 12px; white-space:nowrap;">5ê¸‰</span>
            </th>
            <th style="padding: 10px;"><span
                style="display:inline-block; border-radius:12px; background-color:#64748b; color:#fff; padding:4px 12px; white-space:nowrap;">6ê¸‰</span>
            </th>
            <th style="padding: 10px;"><span
                style="display:inline-block; border-radius:12px; background-color:#94a3b8; color:#fff; padding:4px 12px; white-space:nowrap;">ë“±ê¸‰
                ì—†ìŒ</span></th>
            <th style="padding: 10px;"><span
                style="display:inline-block; border-radius:12px; background-color:#475569; color:#fff; padding:4px 12px; white-space:nowrap;">ê¸°íƒ€</span>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr style="font-size: 1.2rem; font-weight: bold;">
            <td style="padding: 10px;">{{ grade_stats['1ê¸‰'] }}</td>
            <td style="padding: 10px;">{{ grade_stats['2ê¸‰'] }}</td>
            <td style="padding: 10px;">{{ grade_stats['3ê¸‰'] }}</td>
            <td style="padding: 10px;">{{ grade_stats['4ê¸‰'] }}</td>
            <td style="padding: 10px;">{{ grade_stats['5ê¸‰'] }}</td>
            <td style="padding: 10px;">{{ grade_stats['6ê¸‰'] }}</td>
            <td style="padding: 10px;">{{ grade_stats['ë“±ê¸‰ ì—†ìŒ'] }}</td>
            <td style="padding: 10px;">{{ grade_stats['ê¸°íƒ€'] }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    {% if analysis_result %}

    <!-- [MOVED] ì‹œê°í™” ì„¹ì…˜ (ì›ê·¸ë˜í”„ + í•˜ì´ë¼ì´íŠ¸ ì›ë¬¸) - ìš°ì„  ìˆœìœ„ ë³€ê²½ -->
    {% if visualization_data %}
    {% include 'components/visualization.html' %}
    {% endif %}

    <!-- [MOVED] ëª¨ë“ˆí™”ëœ ë¶„ì„ í…Œì´ë¸” ì»´í¬ë„ŒíŠ¸ -->
    {% include 'components/analysis_table.html' %}

    {% endif %}
  </article>
  {% endif %}



  {% if debug_log %}
  <details style="margin-top: 0.5rem;">
    <summary style="font-weight: bold; cursor: pointer; color: #ff6b6b;">ğŸ› ï¸ ê²€ìˆ˜ìš© ìƒì„¸ ë¡œê·¸ (Debug)</summary>
    <pre class="log" style="margin-top: 0.5rem; font-size: 0.9rem; line-height: 1.5;">{{ debug_log }}</pre>
  </details>
  {% endif %}

</section>

<script>
  // [UI] í‘œ ë‚´ìš©ì„ íƒ­(Tab) êµ¬ë¶„ í…ìŠ¤íŠ¸ë¡œ ë³µì‚¬í•˜ëŠ” í•¨ìˆ˜
  function copyTableText() {
    const table = document.getElementById('analysis-table');
    if (!table) return;

    let textToCopy = "";

    // í—¤ë” ê°€ì ¸ì˜¤ê¸°
    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText);
    textToCopy += headers.join('\t') + '\n';

    // ë³¸ë¬¸ í–‰ ê°€ì ¸ì˜¤ê¸°
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
      const cells = Array.from(row.querySelectorAll('td')).map(td => td.innerText.replace(/[\r\n]+/g, " ").trim());
      textToCopy += cells.join('\t') + '\n';
    });

    // í´ë¦½ë³´ë“œ ì“°ê¸°
    navigator.clipboard.writeText(textToCopy).then(() => {
      alert('í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì—‘ì…€ì— ë°”ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.');
    }).catch(err => {
      console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
      alert('ë³µì‚¬ ê¶Œí•œ ì˜¤ë¥˜. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    });
  }

  function downloadTableAsCsv() {
    const table = document.getElementById('analysis-table');
    if (!table) return;

    let csvContent = "\uFEFF"; // BOM for Excel

    // í—¤ë” (ë§ˆì§€ë§‰ 'ìˆ˜ì •' ì»¬ëŸ¼ ì œì™¸)
    // analysis_table.html êµ¬ì¡°ìƒ thê°€ 6ê°œ(ë§ˆì§€ë§‰ì€ ìˆ˜ì •). 
    // í•˜ì§€ë§Œ copyTableTextëŠ” th.innerTextë¥¼ ê·¸ëƒ¥ ë‹¤ ê°€ì ¸ì˜¤ëŠ” ë“¯?
    // th êµ¬ì¡° í™•ì¸: í‘œì œì–´, í’ˆì‚¬, ë“±ê¸‰, ë²ˆí˜¸, ê¸¸ì¡ì´ë§, ìˆ˜ì •
    // CSVì—ëŠ” 'ìˆ˜ì •' ì»¬ëŸ¼ì´ í•„ìš” ì—†ìœ¼ë¯€ë¡œ ì œì™¸í•˜ëŠ” ê²Œ ì¢‹ìŒ.

    const headers = Array.from(table.querySelectorAll('thead th'))
      .slice(0, -1) // ë§ˆì§€ë§‰ ì»¬ëŸ¼ ì œì™¸
      .map(th => th.innerText);
    csvContent += headers.join(',') + '\n';

    // ë³¸ë¬¸
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
      const cells = Array.from(row.querySelectorAll('td'))
        .slice(0, -1) // ë§ˆì§€ë§‰ ì»¬ëŸ¼ ì œì™¸
        .map(td => {
          let text = td.innerText.replace(/[\r\n]+/g, " ").trim();
          // ì‰¼í‘œê°€ ìˆìœ¼ë©´ ë”°ì˜´í‘œë¡œ ê°ì‹¸ê¸°
          if (text.includes(',')) text = `"${text}"`;
          return text;
        });
      csvContent += cells.join(',') + '\n';
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', 'analysis_result.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // ê¸°ì¡´ JS ìœ ì§€
  document.addEventListener('DOMContentLoaded', function () {
    const gradeForm = document.getElementById('grade-form');
    const sentenceInput = document.getElementById('sentence');
    const clearToggle = document.getElementById('clear-toggle');
    const hiddenInput = document.getElementById('clear-toggle-input');

    sentenceInput.addEventListener('keydown', function (event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        gradeForm.submit();
      }
    });

    const savedState = localStorage.getItem('clearOnSubmit');
    if (savedState === 'true') {
      clearToggle.checked = true;
      hiddenInput.value = 'true';
    } else {
      clearToggle.checked = false;
      hiddenInput.value = 'false';
    }

    clearToggle.addEventListener('change', function () {
      hiddenInput.value = this.checked ? 'true' : 'false';
      localStorage.setItem('clearOnSubmit', hiddenInput.value);
    });
  });
</script>

<style>
  .table-container {
    overflow-x: auto;
    border: 1px solid var(--muted-border-color);
    border-radius: 8px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 1.05rem;
  }

  th {
    background-color: rgba(255, 255, 255, 0.05);
    text-align: left;
    font-weight: 600;
    padding: 14px;
  }

  td {
    padding: 14px;
    border-bottom: 1px solid var(--muted-border-color);
    vertical-align: middle;
  }

  tr:last-child td {
    border-bottom: none;
  }

  .grade-badge {
    display: inline-block;
    border-radius: 12px;
    color: #fff;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  }

  .grade-1 {
    background-color: #10b981;
  }

  .grade-2 {
    background-color: #3b82f6;
  }

  .grade-3 {
    background-color: #8b5cf6;
  }

  .grade-4 {
    background-color: #f59e0b;
  }

  .grade-5 {
    background-color: #ef4444;
  }

  .grade-6 {
    background-color: #64748b;
  }
</style>
{% endblock %}