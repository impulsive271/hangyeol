{% extends 'base.html' %}
{% block content %}
  <section>
    <h2>ğŸš€ ì˜ˆë¬¸ ë“±ê¸‰ íŒë…ê¸°</h2>
    <p>ë¬¸ì¥ì„ ì…ë ¥í•˜ê³  ì œì¶œí•˜ë©´ ë“±ê¸‰ê³¼ ìƒì„¸ ë¶„ì„ í‘œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <form method="post" class="form" id="grade-form">
      <label for="sentence">ë¬¸ì¥</label>
      <textarea id="sentence" name="sentence" rows="3" placeholder="ì˜ˆ) ì‚¬ê³¼ê°€ ë§›ì—†ìœ¼ë©´ ì‚¬ê³¼í• ê²Œìš”">{{ last_sentence or '' }}</textarea>

      <div class="toggle-container">
        <label class="toggle-switch">
          <input type="checkbox" id="clear-toggle">
          <span class="slider">
            <span class="slider-text" data-on="ON" data-off="OFF"></span>
          </span>
        </label>
        <label for="clear-toggle" class="toggle-label">ë¬¸ì¥ íŒë… í›„ ì§€ì›Œì§‘ë‹ˆë‹¤.</label>
        <input type="hidden" id="clear-toggle-input" name="clear_on_submit" value="false">
      </div>

      <button type="submit">íŒë…í•˜ê¸°</button>
    </form>

    <hr style="margin: 2rem 0; border-color: var(--muted-border-color);">

    {% if graded_text %}
      <article class="result-card">
        <header>
          <strong style="font-size: 1.3rem;">íŒë… ê²°ê³¼</strong>
        </header>
        
        <div class="grade-display" style="font-size: 1.6rem; margin: 1.5rem 0; line-height: 1.4;">
          {{ graded_text }}
        </div>

        {% if analysis_result %}
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 3rem; margin-bottom: 0.8rem;">
            <h3 style="margin: 0; font-weight: 700;">ğŸ“Š ìƒì„¸ ë¶„ì„</h3>
            <button type="button" class="outline contrast" onclick="copyTableText()" style="padding: 8px 20px; font-size: 0.95rem;">
              ğŸ“‹ í…ìŠ¤íŠ¸ë¡œ ë³µì‚¬
            </button>
          </div>
          
          <div class="table-container">
            <table id="analysis-table" class="striped">
              <thead>
                <tr>
                  <th scope="col" style="width: 15%;">í‘œì œì–´</th>
                  <th scope="col" style="width: 20%;">í’ˆì‚¬</th>
                  <th scope="col" style="width: 10%;">ë“±ê¸‰</th>
                  <th scope="col" style="width: 15%;">ë²ˆí˜¸</th>
                  <th scope="col">ê¸¸ì¡ì´ë§</th>
                </tr>
              </thead>
              <tbody>
                {% for row in analysis_result %}
                <tr>
                  <td style="font-weight: bold; color: var(--color-text);">{{ row.form }}</td>
                  <td>
                    <span data-tooltip="{{ row.tag_code }}">{{ row.tag_name }}</span>
                  </td>
                  <td>
                    {% if 'ê¸‰' in row.level %}
                      <span class="grade-badge grade-{{ row.level[0] }}" style="font-size: 1.1rem; padding: 6px 14px;">{{ row.level }}</span>
                    {% else %}
                      <span style="color: var(--color-text-muted);">-</span>
                    {% endif %}
                  </td>
                  <td style="font-family: monospace; font-size: 0.95rem; color: var(--color-text-muted);">
                    {{ row.id }}
                  </td>
                  <td style="color: var(--color-secondary);">
                    {{ row.desc }}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </article>
    {% endif %}

    <details style="margin-top: 1rem;">
      <summary style="font-weight: bold; cursor: pointer;">ğŸ“‚ ëŒ€ëŸ‰ íŒë… ëª¨ë“œ (íŒŒì¼ ì—…ë¡œë“œ)</summary>
      <div style="padding: 1rem; border: 1px solid var(--muted-border-color); border-radius: 8px; margin-top: 0.5rem;">
        <form action="{{ url_for('grade_upload') }}" method="post" enctype="multipart/form-data" class="grid" style="grid-template-columns: 3fr 1fr; gap: 10px; margin-bottom:0; padding:0; border:none; box-shadow:none; background:transparent;">
          <input type="file" name="file" accept=".txt" required>
          <button type="submit" class="secondary">ì¼ê´„ íŒë…</button>
        </form>
      </div>
    </details>

    {% if debug_log %}
    <details style="margin-top: 0.5rem;">
      <summary style="font-weight: bold; cursor: pointer; color: #ff6b6b;">ğŸ› ï¸ ê²€ìˆ˜ìš© ìƒì„¸ ë¡œê·¸ (Debug)</summary>
      <pre class="log" style="margin-top: 0.5rem; font-size: 0.9rem; line-height: 1.5;">{{ debug_log }}</pre>
    </details>
    {% endif %}

  </section>

  <script>
    // [UI] í‘œ ë‚´ìš©ì„ íƒ­(Tab) êµ¬ë¶„ í…ìŠ¤íŠ¸ë¡œ ë³µì‚¬í•˜ëŠ” í•¨ìˆ˜
    function copyTableText() {
      const table = document.getElementById('analysis-table');
      if (!table) return;

      let textToCopy = "";
      
      // í—¤ë” ê°€ì ¸ì˜¤ê¸°
      const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText);
      textToCopy += headers.join('\t') + '\n';

      // ë³¸ë¬¸ í–‰ ê°€ì ¸ì˜¤ê¸°
      const rows = table.querySelectorAll('tbody tr');
      rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll('td')).map(td => td.innerText.replace(/[\r\n]+/g, " ").trim());
        textToCopy += cells.join('\t') + '\n';
      });

      // í´ë¦½ë³´ë“œ ì“°ê¸°
      navigator.clipboard.writeText(textToCopy).then(() => {
        alert('í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì—‘ì…€ì— ë°”ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.');
      }).catch(err => {
        console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
        alert('ë³µì‚¬ ê¶Œí•œ ì˜¤ë¥˜. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      });
    }

    // ê¸°ì¡´ JS ìœ ì§€
    document.addEventListener('DOMContentLoaded', function() {
      const gradeForm = document.getElementById('grade-form');
      const sentenceInput = document.getElementById('sentence');
      const clearToggle = document.getElementById('clear-toggle');
      const hiddenInput = document.getElementById('clear-toggle-input');

      sentenceInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          gradeForm.submit();
        }
      });

      const savedState = localStorage.getItem('clearOnSubmit');
      if (savedState === 'true') {
        clearToggle.checked = true;
        hiddenInput.value = 'true';
      } else {
        clearToggle.checked = false;
        hiddenInput.value = 'false';
      }

      clearToggle.addEventListener('change', function() {
        hiddenInput.value = this.checked ? 'true' : 'false';
        localStorage.setItem('clearOnSubmit', hiddenInput.value);
      });
    });
  </script>

  <style>
    .table-container { overflow-x: auto; border: 1px solid var(--muted-border-color); border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; font-size: 1.05rem; }
    th { background-color: rgba(255, 255, 255, 0.05); text-align: left; font-weight: 600; padding: 14px; }
    td { padding: 14px; border-bottom: 1px solid var(--muted-border-color); vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    
    .grade-badge { display: inline-block; border-radius: 12px; color: #fff; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .grade-1 { background-color: #10b981; }
    .grade-2 { background-color: #3b82f6; }
    .grade-3 { background-color: #8b5cf6; }
    .grade-4 { background-color: #f59e0b; }
    .grade-5 { background-color: #ef4444; }
    .grade-6 { background-color: #64748b; }
  </style>
{% endblock %}