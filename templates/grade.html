{% extends 'base.html' %}
{% block content %}
<section>
  <h2 id="section-input" style="scroll-margin-top: 100px;">ğŸš€ ë¶„ì„</h2>
  <p>í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê³  ì œì¶œí•˜ë©´ ë“±ê¸‰ê³¼ ìƒì„¸ ë¶„ì„ í‘œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

  <form method="post" action="{{ url_for('main.grade') }}" class="form" id="grade-form">
    <label for="sentence">í…ìŠ¤íŠ¸</label>
    <textarea id="sentence" name="sentence" rows="3"
      placeholder="ì˜ˆ) ì‚¬ê³¼ê°€ ë§›ì—†ìœ¼ë©´ ì‚¬ê³¼í• ê²Œìš”">{{ last_sentence or '' }}</textarea>

    <div class="toggle-container">
      <label class="toggle-switch">
        <input type="checkbox" id="clear-toggle">
        <span class="slider">
          <span class="slider-text" data-on="ON" data-off="OFF"></span>
        </span>
      </label>
      <label for="clear-toggle" class="toggle-label">ë¶„ì„ í›„ ì§€ì›Œì§‘ë‹ˆë‹¤.</label>
      <input type="hidden" id="clear-toggle-input" name="clear_on_submit" value="false">
    </div>

    <button type="submit">ğŸ“ í…ìŠ¤íŠ¸ ë¶„ì„í•˜ê¸°</button>
  </form>

  <details style="margin-top: 1rem; margin-bottom: 2rem;">
    <summary style="font-weight: bold; cursor: pointer;">ğŸ“‚ íŒŒì¼ ì—…ë¡œë“œ (.txt)</summary>
    <div style="padding: 1rem; border: 1px solid var(--muted-border-color); border-radius: 8px; margin-top: 0.5rem;">
      <form action="{{ url_for('main.grade_upload') }}" method="post" enctype="multipart/form-data" class="grid"
        style="grid-template-columns: 1fr; gap: 10px; margin-bottom:0; padding:0; border:none; box-shadow:none; background:transparent; backdrop-filter:none; -webkit-backdrop-filter:none;">

        <!-- [NEW] Hidden Real Input -->
        <input type="file" id="hidden-file-input" name="file" accept=".txt" multiple style="display: none;">

        <!-- [NEW] Custom UI (Simplified + Drop Zone) -->
        <div id="drop-zone" class="file-upload-wrapper">
          <!-- Simple Button (Restored Style) -->
          <button type="button" class="secondary outline" onclick="document.getElementById('hidden-file-input').click()"
            style="width: 100%; margin-bottom: 0;">
            ğŸ“‚ íŒŒì¼ ì„ íƒ (ë˜ëŠ” ë“œë˜ê·¸)
          </button>

          <!-- File List (Initially Hidden) -->
          <div id="file-list-container" class="file-list-container" style="display: none;">
            <!-- JS will populate file blocks here -->
          </div>
        </div>

        <button type="submit" class="primary" id="upload-btn" disabled
          style="display: none; margin-top: 10px; width: 100%;">ğŸ“‚ íŒŒì¼ ë¶„ì„í•˜ê¸°</button>
      </form>
      <small style="color: var(--color-text-muted); display: block; margin-top: 10px;">â€» <strong>.txt</strong> íŒŒì¼ë§Œ
        ì§€ì›í•©ë‹ˆë‹¤.</small>
    </div>
  </details>

  <hr style="margin: 2rem 0; border-color: var(--muted-border-color);">

  {% if file_stats_list %}
  <article class="result-card">
    <header>
      <strong style="font-size: 1.3rem;">ë¶„ì„ ê²°ê³¼</strong>
    </header>

    <!-- [NEW] ë“±ê¸‰ ë¹ˆë„ìˆ˜ í…Œì´ë¸” -->
    <!-- [NEW] ë“±ê¸‰ ë¹ˆë„ìˆ˜ í…Œì´ë¸” ì»´í¬ë„ŒíŠ¸ -->
    {% include 'components/frequency_table.html' %}


    <!-- [NEW] Quick Jump Side Menu (Toggleable) -->
    {% include 'components/sidebar.html' %}


    {% if analysis_result %}

    <!-- [MOVED] ì‹œê°í™” ì„¹ì…˜ (ì›ê·¸ë˜í”„ + í•˜ì´ë¼ì´íŠ¸ ì›ë¬¸) - ìš°ì„  ìˆœìœ„ ë³€ê²½ -->
    {% if visualization_data %}
    {% include 'components/visualization.html' %}
    {% endif %}

    <!-- [MOVED] ëª¨ë“ˆí™”ëœ ë¶„ì„ í…Œì´ë¸” ì»´í¬ë„ŒíŠ¸ -->
    {% include 'components/analysis_table.html' %}

    {% endif %}
  </article>
  {% endif %}



  {% if debug_log %}
  <details style="margin-top: 0.5rem;">
    <summary style="font-weight: bold; cursor: pointer; color: #ff6b6b;">ğŸ› ï¸ ê²€ìˆ˜ìš© ìƒì„¸ ë¡œê·¸ (Debug)</summary>
    <pre class="log" style="margin-top: 0.5rem; font-size: 0.9rem; line-height: 1.5;">{{ debug_log }}</pre>
  </details>
  {% endif %}

</section>

<script>
  // [UI] í‘œ ë‚´ìš©ì„ íƒ­(Tab) êµ¬ë¶„ í…ìŠ¤íŠ¸ë¡œ ë³µì‚¬í•˜ëŠ” í•¨ìˆ˜
  function copyTableText(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;

    let textToCopy = "";

    // í—¤ë” ê°€ì ¸ì˜¤ê¸°
    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText.trim());
    textToCopy += headers.join('\t') + '\n';

    // ë³¸ë¬¸ í–‰ ê°€ì ¸ì˜¤ê¸°
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
      const cells = Array.from(row.querySelectorAll('td')).map(td => td.innerText.replace(/[\r\n]+/g, " ").trim());
      textToCopy += cells.join('\t') + '\n';
    });

    // í´ë¦½ë³´ë“œ ì“°ê¸°
    navigator.clipboard.writeText(textToCopy).then(() => {
      alert('í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì—‘ì…€ì— ë°”ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.');
    }).catch(err => {
      console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
      alert('ë³µì‚¬ ê¶Œí•œ ì˜¤ë¥˜. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    });
  }

  function downloadTableAsCsv(tableId, filename) {
    const table = document.getElementById(tableId);
    if (!table) return;

    let csvContent = "\uFEFF"; // BOM for Excel

    // í—¤ë”
    const headers = Array.from(table.querySelectorAll('thead th'))
      //.slice(0, -1) // Removed hardcoded slice - filtering logic should be handled by caller or generic
      .filter(th => th.innerText !== 'ìˆ˜ì •') // Simple filtering: prevent 'ìˆ˜ì •' col
      .map(th => th.innerText.trim());
    csvContent += headers.join(',') + '\n';

    // ë³¸ë¬¸
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
      const cells = Array.from(row.querySelectorAll('td'))
        //.slice(0, -1) // Removed hardcoded slice
        .filter((td, index) => {
          // Filter out 'ìˆ˜ì •' column if it exists in header. 
          // We can check if corresponding header is 'ìˆ˜ì •' but let's just exclude last one if it is button
          const btn = td.querySelector('.btn-edit-row');
          return !btn;
        })
        .map(td => {
          let text = td.innerText.replace(/[\r\n]+/g, " ").trim();
          // ì‰¼í‘œê°€ ìˆìœ¼ë©´ ë”°ì˜´í‘œë¡œ ê°ì‹¸ê¸°
          if (text.includes(',')) text = `"${text}"`;
          return text;
        });
      csvContent += cells.join(',') + '\n';
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', filename || 'table_data.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // ê¸°ì¡´ JS ìœ ì§€
  document.addEventListener('DOMContentLoaded', function () {
    const gradeForm = document.getElementById('grade-form');
    const sentenceInput = document.getElementById('sentence');
    const clearToggle = document.getElementById('clear-toggle');
    const hiddenInput = document.getElementById('clear-toggle-input');

    sentenceInput.addEventListener('keydown', function (event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        gradeForm.submit();
      }
    });

    const savedState = localStorage.getItem('clearOnSubmit');
    if (savedState === 'true') {
      clearToggle.checked = true;
      hiddenInput.value = 'true';
    } else {
      clearToggle.checked = false;
      hiddenInput.value = 'false';
    }

    clearToggle.addEventListener('change', function () {
      hiddenInput.value = this.checked ? 'true' : 'false';
      localStorage.setItem('clearOnSubmit', hiddenInput.value);
    });

    // [NEW] File Upload Logic
    initFileUpload();
  });

  // [NEW] File Upload & Reordering Module
  function initFileUpload() {
    const fileInput = document.getElementById('hidden-file-input');
    const fileListContainer = document.getElementById('file-list-container');
    const uploadBtn = document.getElementById('upload-btn');
    const dropZone = document.getElementById('drop-zone');

    // Global array to maintain file order
    let currentFiles = [];

    // --- 1. File Selection Handler (Input Change) ---
    fileInput.addEventListener('change', (e) => {
      handleFiles(Array.from(e.target.files));
      // Allow re-selecting same file
      e.target.value = '';
    });

    // --- 2. OS Drag & Drop Handler ---
    // Prevent default behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    // Highlight drop zone
    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => dropZone.classList.add('highlight'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => dropZone.classList.remove('highlight'), false);
    });

    // Handle dropped files
    dropZone.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = Array.from(dt.files).filter(f => f.name.endsWith('.txt')); // Simple filter

      if (dt.files.length > 0 && files.length === 0) {
        alert("í˜„ì¬ .txt íŒŒì¼ë§Œ ì§€ì›í•©ë‹ˆë‹¤.");
        return;
      }

      handleFiles(files);
    });

    // --- 3. Unified File Handler ---
    function handleFiles(newFiles) {
      const existingNames = new Set(currentFiles.map(f => f.name));
      let addedCount = 0;

      newFiles.forEach(f => {
        if (!existingNames.has(f.name)) {
          currentFiles.push(f);
          addedCount++;
        }
      });

      if (addedCount > 0) {
        renderFileList();
        updateRealInput();
      }
    }

    // --- 4. Render List ---
    function renderFileList() {
      fileListContainer.innerHTML = '';

      if (currentFiles.length === 0) {
        fileListContainer.style.display = 'none';
        uploadBtn.style.display = 'none';
        uploadBtn.disabled = true;
        return;
      }

      fileListContainer.style.display = 'flex';
      uploadBtn.style.display = 'block';
      uploadBtn.disabled = false;

      currentFiles.forEach((file, index) => {
        const block = document.createElement('div');
        block.className = 'file-block';
        block.draggable = true;
        block.dataset.index = index;
        // Prevent drag from propagating to the parent drop zone
        block.addEventListener('dragstart', (e) => {
          e.stopPropagation(); // Stop bubbling to dropZone
          handleInternalDragStart.call(block, e);
        });

        block.innerHTML = `
                <div class="drag-handle">â˜°</div>
                <div class="file-name">${file.name}</div>
                <button type="button" class="remove-btn" onclick="removeFile(${index})">âœ•</button>
            `;

        // Internal Sort Drag Events
        // NOTE: We need separate handlers to avoid conflict with OS drop
        block.addEventListener('dragover', handleInternalDragOver);
        block.addEventListener('drop', handleInternalDrop);
        block.addEventListener('dragenter', (e) => e.preventDefault()); // Necessary

        fileListContainer.appendChild(block);
      });
    }

    // --- 5. Remove & Update ---
    window.removeFile = function (index) {
      currentFiles.splice(index, 1);
      renderFileList();
      updateRealInput();
    };

    function updateRealInput() {
      const dataTransfer = new DataTransfer();
      currentFiles.forEach(file => dataTransfer.items.add(file));
      fileInput.files = dataTransfer.files;
    }

    // --- 6. Internal Reordering Logic ---
    let dragSrcEl = null;

    function handleInternalDragStart(e) {
      dragSrcEl = this;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', this.dataset.index);
      this.classList.add('dragging');
    }

    function handleInternalDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function handleInternalDrop(e) {
      if (e.stopPropagation) e.stopPropagation();

      // Ensure we are dropping on a file-block
      const targetBlock = this.closest('.file-block');
      if (dragSrcEl && targetBlock && dragSrcEl !== targetBlock) {
        const srcIndex = parseInt(dragSrcEl.dataset.index);
        const targetIndex = parseInt(targetBlock.dataset.index);

        const item = currentFiles.splice(srcIndex, 1)[0];
        currentFiles.splice(targetIndex, 0, item);

        renderFileList();
        updateRealInput();
      }
      return false;
    }
  }
</script>

<style>
  .table-container {
    overflow-x: auto;
    border: 1px solid var(--muted-border-color);
    border-radius: 8px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 1.05rem;
  }

  th {
    background-color: rgba(255, 255, 255, 0.05);
    text-align: left;
    font-weight: 600;
    padding: 14px;
  }

  td {
    padding: 14px;
    border-bottom: 1px solid var(--muted-border-color);
    vertical-align: middle;
  }

  tr:last-child td {
    border-bottom: none;
  }

  .grade-badge {
    display: inline-block;
    border-radius: 12px;
    color: #fff;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  }

  .grade-1 {
    background-color: #10b981;
  }

  .grade-2 {
    background-color: #3b82f6;
  }

  .grade-3 {
    background-color: #8b5cf6;
  }

  .grade-4 {
    background-color: #f59e0b;
  }

  .grade-5 {
    background-color: #ef4444;
  }

  .grade-6 {
    background-color: #64748b;
  }

  /* File Upload UI */
  .file-list-container {
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .file-block {
    background-color: var(--color-card-bg);
    border: 1px solid var(--muted-border-color);
    border-radius: 6px;
    padding: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.2s ease;
    cursor: grab;
    user-select: none;
  }

  .file-block:active {
    cursor: grabbing;
  }

  /* Dragging State */
  .file-block.dragging {
    opacity: 0.4;
    border: 2px dashed var(--color-primary);
  }

  .file-block.drag-over {
    border: 2px solid var(--color-primary);
    transform: scale(1.02);
  }

  .drag-handle {
    color: var(--color-text-muted);
    cursor: grab;
    font-size: 1.2rem;
  }

  .file-name {
    flex-grow: 1;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .remove-btn {
    background: none;
    border: none;
    color: var(--color-text-muted);
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0 5px;
    transition: color 0.2s;
    width: auto !important;
    margin: 0 !important;
    box-shadow: none !important;
  }

  .remove-btn:hover {
    color: #ef4444;
    /* Red */
  }
</style>
{% endblock %}